<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://accounts.google.com/gsi/client" onload="window.__gsiLoaded=true"></script>
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial; margin: 18px; }
    .card { border:1px solid #ddd; border-radius:14px; padding:14px; margin-bottom:14px; }
    input, textarea { width:100%; padding:10px; border-radius:10px; border:1px solid #ccc; font-size:16px; }
    button { padding:10px 14px; border-radius:12px; border:1px solid #333; background:#111; color:#fff; font-size:16px; }
    button.alt { background:#fff; color:#111; }
    button:disabled { opacity:.6; }
    .small { color:#666; font-size:13px; }
    .list { margin-top:10px; }
    .item { padding:10px 0; border-top:1px solid #eee; }
  </style>
</head>
<body>
  <div class="card">
    <b>Acesso</b>
    <div class="small" id="authStatus">FaÃ§a login para usar.</div>
    <div id="gsiBtn" style="margin-top:8px; min-height:44px;"></div>
    <button id="fallbackLogin" class="alt" style="display:none; margin-top:8px;" onclick="loginFallback()">
      Entrar com Google
    </button>
  </div>

  <div class="card">
    <h2 style="margin:0 0 8px 0;">ðŸ“š Biblioteca - FamÃ­lia Batista</h2>
    <div class="small">Cadastre por ISBN (digitando, leitor ou cÃ¢mera).</div>
  </div>

  <div class="card">
    <label><b>ISBN</b></label>
    <input id="isbn" inputmode="numeric" placeholder="Ex.: 9788576082675" autocomplete="off">
    <div style="height:10px"></div>

    <label><b>LocalizaÃ§Ã£o</b> <span class="small">(opcional)</span></label>
    <input id="location" placeholder="Ex.: Estante sala, prateleira 2">
    <div style="height:10px"></div>

    <label><b>ObservaÃ§Ãµes</b> <span class="small">(opcional)</span></label>
    <textarea id="notes" rows="2"></textarea>

    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px;">
      <button id="btn" onclick="cadastrar()">Cadastrar</button>
      <button class="alt" onclick="abrirScanner()">ðŸ“· Escanear ISBN</button>
      <span id="status" class="small"></span>
    </div>
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <b>Ãšltimos cadastrados</b>
      <button class="alt" onclick="carregarRecentes()">Atualizar</button>
    </div>
    <div id="recentes" class="list"></div>
  </div>

  <div class="card">
    <b>Acervo</b>
    <div class="small">Busque por tÃ­tulo, autor, editora, ISBN, ano, localizaÃ§Ã£o...</div>
    <div style="display:flex; gap:10px; margin-top:10px;">
      <input id="q" placeholder="Buscar...">
      <button class="alt" onclick="buscar()">Buscar</button>
    </div>
    <div class="small" id="resumo" style="margin-top:8px;"></div>
    <div id="acervo" class="list"></div>
    <div style="display:flex; gap:10px; margin-top:10px;">
      <button class="alt" onclick="prev()">â—€</button>
      <button class="alt" onclick="next()">â–¶</button>
    </div>
  </div>

  <div id="scannerModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.75); padding:18px;">
    <div style="background:#fff; border-radius:14px; padding:14px; max-width:680px; margin:0 auto;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <b>Escanear ISBN</b>
        <button class="alt" onclick="fecharScanner()">Fechar</button>
      </div>
      <div class="small" style="margin:8px 0 10px 0;">Aponte para o cÃ³digo de barras (EAN-13).</div>
      <video id="video" style="width:100%; border-radius:12px; border:1px solid #ddd;" autoplay muted playsinline></video>
      <div class="small" id="scanStatus" style="margin-top:8px;"></div>
    </div>
  </div>

<script type="module">
  import * as ZXing from "https://cdn.jsdelivr.net/npm/@zxing/browser@latest/+esm";
  window.ZXing = ZXing; // deixa disponÃ­vel para seu cÃ³digo atual
</script>  
<script>
  const CLIENT_ID = "633125662554-rjlr69ihdv7g0njfgl9doacnsmdmkcbh.apps.googleusercontent.com";

  // Sua URL do Apps Script (API)
  const API_URL = "https://script.google.com/macros/s/AKfycbyMm03BzNNkA5lNbsXBb4CH6cBasRRYO-gtDRkTgUwuULQrjHi1U_YqqBmxwO2AgSAm/exec";

  let ID_TOKEN = "";
  let OFFSET = 0;
  const LIMIT = 50;
  let codeReader = null;

  const $ = id => document.getElementById(id);

  $("isbn").addEventListener("keydown", e => { if (e.key === "Enter") cadastrar(); });

  function setLoading(on, msg="") {
    $("btn").disabled = on;
    $("status").textContent = msg;
  }

  function api(action, payload = {}) {
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Date.now() + "_" + Math.floor(Math.random() * 100000);

    window[cb] = (data) => {
      try { delete window[cb]; } catch(e) {}
      script.remove();
      resolve(data);
    };

    const params = new URLSearchParams();
    params.set("callback", cb);
    params.set("action", action);
    params.set("idToken", ID_TOKEN);

    // payload bÃ¡sico
    if (payload.limit != null) params.set("limit", String(payload.limit));
    if (payload.query != null) params.set("query", String(payload.query));
    if (payload.offset != null) params.set("offset", String(payload.offset));
    if (payload.isbn != null) params.set("isbn", String(payload.isbn));

    // extras (JSON)
    if (payload.extras != null) {
      params.set("extras", encodeURIComponent(JSON.stringify(payload.extras)));
    }

    const script = document.createElement("script");
    script.src = API_URL + "?" + params.toString();
    script.onerror = () => {
      try { delete window[cb]; } catch(e) {}
      script.remove();
      reject(new Error("Falha ao chamar API (JSONP)."));
    };

    document.body.appendChild(script);
  });
}

function initLogin() {
  const start = () => {
    try {
      google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: (resp) => {
          ID_TOKEN = resp.credential || "";
          $("authStatus").textContent = "âœ… Logado.";
          $("fallbackLogin").style.display = "none";
          carregarRecentes();
          buscar();
          $("isbn").focus();
        }
      });

      // Tenta renderizar o botÃ£o oficial
      google.accounts.id.renderButton($("gsiBtn"), {
        theme: "outline",
        size: "large",
        text: "signin_with"
      });

      // Se por algum motivo o botÃ£o nÃ£o aparecer, mostra fallback
      setTimeout(() => {
        const empty = !$("gsiBtn").innerHTML || $("gsiBtn").innerHTML.trim() === "";
        if (empty) $("fallbackLogin").style.display = "inline-block";
      }, 800);

    } catch (e) {
      // Se der qualquer erro, ativa fallback
      $("fallbackLogin").style.display = "inline-block";
      $("authStatus").textContent = "Toque em 'Entrar com Google'.";
    }
  };

  // Espera o script carregar (iOS/Safari Ã© chato com async/defer)
  const wait = () => {
    if (window.__gsiLoaded && window.google && google.accounts && google.accounts.id) start();
    else setTimeout(wait, 120);
  };
  wait();
}

  function loginFallback() {
  try {
    // Mostra o â€œone tap / promptâ€ do Google
    google.accounts.id.prompt((notification) => {
      // Se o prompt nÃ£o puder ser exibido, dÃ¡ uma dica
      if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
        $("authStatus").textContent = "Login nÃ£o exibido. Tente abrir no Safari (nÃ£o no modo embutido) e permita cookies.";
      }
    });
  } catch (e) {
    $("authStatus").textContent = "Falha ao iniciar login. Recarregue a pÃ¡gina.";
  }
}

  async function cadastrar() {
  if (!ID_TOKEN) { setLoading(false, "FaÃ§a login antes."); return; }

  const isbn = $("isbn").value.trim();
  if (!isbn) return;

  // regra simples: exigir 13 dÃ­gitos (ISBN/EAN-13)
  if (!/^\d{13}$/.test(isbn)) {
    setLoading(false, "O cÃ³digo lido nÃ£o Ã© ISBN-13 (precisa ter 13 dÃ­gitos). Tente novamente.");
    return;
  }

  setLoading(true, "Buscando...");
  const extras = { location: $("location").value.trim(), notes: $("notes").value.trim() };

  try {
    const res = await api("cadastrar", { isbn, extras });
    if (!res || !res.ok) {
      setLoading(false, (res && res.message) ? res.message : "Falhou.");
      return;
    }

    setLoading(false, `âœ… ${res.action === "updated" ? "Atualizado" : "Cadastrado"}: ${(res.meta && res.meta.title) || ""}`);
    $("isbn").value = "";
    $("isbn").focus();
    carregarRecentes();
    buscar();
  } catch (e) {
    setLoading(false, "Erro: " + (e?.message || e));
  }
}

  async function carregarRecentes() {
    if (!ID_TOKEN) return;
    const res = await api("recentes", { limit: 20 });
    const el = $("recentes");
    el.innerHTML = "";
    (res.items || []).forEach(it => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML =
        `<b>${esc(it.title||"(sem tÃ­tulo)")}</b>
         <div class="small">${esc(it.authors||"")}</div>
         <div class="small">ISBN: ${esc(it.isbn||"")} Â· ${esc(it.publisher||"")} Â· ${esc(it.year||"")} Â· ${esc(it.source||"")}</div>`;
      el.appendChild(div);
    });
  }

  function buscar() { OFFSET = 0; carregarPagina(); }
  async function carregarPagina() {
    const q = $("q").value.trim();
    const res = await api("buscar", { query: q, offset: OFFSET, limit: LIMIT });
    $("resumo").textContent = `Total: ${res.total} | PÃ¡gina: ${Math.floor(OFFSET/LIMIT)+1}`;
    const el = $("acervo"); el.innerHTML = "";
    (res.items||[]).forEach(it => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML =
        `<b>${esc(it.title||"(sem tÃ­tulo)")}</b>
         <div class="small">${esc(it.authors||"")}</div>
         <div class="small">ISBN: ${esc(it.isbn||"")} Â· ${esc(it.publisher||"")} Â· ${esc(it.year||"")} Â· ${esc(it.location||"")}</div>`;
      el.appendChild(div);
    });
  }
  function next(){ OFFSET += LIMIT; carregarPagina(); }
  function prev(){ OFFSET = Math.max(0, OFFSET-LIMIT); carregarPagina(); }

  async function abrirScanner() {
  if (!ID_TOKEN) { $("status").textContent = "FaÃ§a login antes de escanear."; return; }

  $("scannerModal").style.display = "block";
  $("scanStatus").textContent = "Abrindo cÃ¢mera...";

  if (!window.ZXing) {
    $("scanStatus").textContent = "Carregando scanner...";
    await new Promise(r => setTimeout(r, 300));
    if (!window.ZXing) { $("scanStatus").textContent = "Scanner nÃ£o carregou. Recarregue a pÃ¡gina."; return; }
  }

  try {
    codeReader = new window.ZXing.BrowserMultiFormatReader();
    const video = $("video");

    const devices = await window.ZXing.BrowserCodeReader.listVideoInputDevices();
    const backCam = devices.find(d => /back|traseira|rear/i.test(d.label)) || devices[0];

    await codeReader.decodeFromVideoDevice(backCam?.deviceId, video, (result) => {
      if (result) {
        const raw = result.getText().replace(/\D/g, "");
      if (raw.length !== 13) return; // ignora EAN-8, etc.
        $("isbn").value = raw;
        $("scanStatus").textContent = "âœ… Detectado";
        fecharScanner();
        $("isbn").focus();
      }
    });

    $("scanStatus").textContent = "Aponte para o cÃ³digo...";
  } catch(e) {
    $("scanStatus").textContent = "Erro cÃ¢mera: " + (e?.message || e);
  }
}

  function fecharScanner() {
    $("scannerModal").style.display = "none";
    try { codeReader && codeReader.reset(); } catch(e){}
    codeReader = null;
  }

  function esc(s){ return String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])); }

  initLogin();
</script>
</body>
</html>
