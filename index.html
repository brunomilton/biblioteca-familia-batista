<!doctype html>
<html lang="pt-BR">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script>
    window.__gsiLoaded = false;
    window.__gsiFailed = false;
    function __onGsiLoad(){ window.__gsiLoaded = true; }
    function __onGsiError(){ window.__gsiFailed = true; }
  </script>
  <script src="https://accounts.google.com/gsi/client"
          onload="__onGsiLoad()"
          onerror="__onGsiError()"></script>

  <style>
    body { font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial; margin:14px; }
    .card { border:1px solid #ddd; border-radius:14px; padding:14px; margin-bottom:12px; }
    input, textarea, select { width:100%; padding:10px; border-radius:10px; border:1px solid #ccc; font-size:16px; box-sizing:border-box; }
    button { padding:10px 14px; border-radius:12px; border:1px solid #333; background:#111; color:#fff; font-size:16px; }
    button.alt { background:#fff; color:#111; }
    button:disabled { opacity:.6; }
    .small { color:#666; font-size:13px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .list { margin-top:8px; }
    .item { padding:10px 0; border-top:1px solid #eee; }
    .tabs { display:flex; gap:8px; margin-bottom:10px; }
    .tab { flex:1; }
    .hidden { display:none; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; color:#333; background:#fafafa; }
  </style>
</head>
<body>

<div class="card">
  <b>Acesso</b>
  <div class="small" id="authStatus">Fa√ßa login para usar.</div>
  <div id="gsiBtn" style="margin-top:8px; min-height:44px;"></div>

  <button id="fallbackLogin" class="alt" style="display:none; margin-top:8px;" onclick="loginFallback()">
    Entrar com Google
  </button>

  <div id="diag" class="small" style="margin-top:8px;"></div>
</div>

<div class="card">
  <h2 style="margin:0 0 6px 0;">üìö Biblioteca - Fam√≠lia Batista</h2>
  <div class="small">Cadastre por ISBN (digitando, leitor ou c√¢mera) ou manualmente.</div>
  <div style="margin-top:10px" class="tabs">
    <button class="alt tab" id="tabCad" onclick="showTab('cad')">Cadastrar</button>
    <button class="alt tab" id="tabAce" onclick="showTab('acervo')">Acervo</button>
    <button class="alt tab" id="tabUsr" onclick="showTab('users')">Usu√°rios</button>
  </div>
  <div class="small">Logado como: <span class="pill" id="rolePill">‚Äî</span></div>
</div>

<!-- ===== TAB: CADASTRO ===== -->
<section id="cad" class="card">
  <b>Cadastro por ISBN</b>
  <div style="height:8px"></div>

  <label><b>ISBN</b></label>
  <input id="isbn" inputmode="numeric" placeholder="Ex.: 9788576082675" autocomplete="off">

  <div style="height:10px"></div>
  <label><b>Localiza√ß√£o</b> <span class="small">(opcional)</span></label>
  <input id="location" placeholder="Ex.: Estante sala, prateleira 2">

  <div style="height:10px"></div>
  <label><b>Observa√ß√µes</b> <span class="small">(opcional)</span></label>
  <textarea id="notes" rows="2"></textarea>

  <div class="row" style="margin-top:10px;">
    <button id="btnCadastrar" onclick="cadastrar()">Cadastrar</button>
    <button class="alt" onclick="abrirScanner()">üì∑ Escanear ISBN</button>
    <button class="alt" onclick="openManual()">‚úçÔ∏è Cadastro manual</button>
    <span id="status" class="small"></span>
  </div>

  <div style="height:14px"></div>
  <b>√öltimos cadastrados</b>
  <div class="row" style="margin-top:8px;">
    <button class="alt" onclick="carregarRecentes()">Atualizar</button>
  </div>
  <div id="recentes" class="list"></div>
</section>

<!-- ===== TAB: ACERVO ===== -->
<section id="acervo" class="card hidden">
  <b>Acervo</b>
  <div class="small">Busque por t√≠tulo, autor, editora, ID/ISBN, ano, localiza√ß√£o...</div>
  <div class="row" style="margin-top:10px;">
    <input id="q" placeholder="Buscar...">
    <button class="alt" onclick="buscar()">Buscar</button>
  </div>
  <div class="small" id="resumo" style="margin-top:8px;"></div>
  <div id="acervoList" class="list"></div>
  <div class="row" style="margin-top:10px;">
    <button class="alt" onclick="prev()">‚óÄ</button>
    <button class="alt" onclick="next()">‚ñ∂</button>
  </div>
</section>

<!-- ===== TAB: USERS ===== -->
<section id="users" class="card hidden">
  <b>Usu√°rios</b>
  <div class="small">Somente admin pode gerenciar permiss√µes.</div>

  <div id="usersGate" class="small" style="margin-top:10px;"></div>

  <div id="usersAdmin" class="hidden" style="margin-top:10px;">
    <div class="row">
      <button class="alt" onclick="loadUsers()">Atualizar lista</button>
    </div>

    <div style="height:10px"></div>
    <b>Adicionar / Atualizar</b>
    <div style="height:8px"></div>

    <label>Email</label>
    <input id="u_email" placeholder="ex.: pessoa@gmail.com">

    <div style="height:8px"></div>
    <label>Nome</label>
    <input id="u_name" placeholder="opcional">

    <div style="height:8px"></div>
    <label>Role</label>
    <select id="u_role">
      <option value="viewer">viewer</option>
      <option value="editor">editor</option>
      <option value="admin">admin</option>
    </select>

    <div style="height:8px"></div>
    <label><input type="checkbox" id="u_active" checked> Ativo</label>

    <div class="row" style="margin-top:10px;">
      <button id="btnUpsert" onclick="upsertUser()">Salvar</button>
      <span id="u_status" class="small"></span>
    </div>

    <div style="height:14px"></div>
    <b>Lista</b>
    <div id="usersList" class="list"></div>
  </div>
</section>

<!-- ===== MODAL: MANUAL ===== -->
<div id="manualModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); padding:14px;">
  <div style="background:#fff; border-radius:14px; padding:14px; max-width:720px; margin:0 auto;">
    <div class="row" style="justify-content:space-between;">
      <b>Cadastro manual</b>
      <button class="alt" onclick="closeManual()">Fechar</button>
    </div>

    <div style="height:10px"></div>
    <label><b>T√≠tulo</b></label>
    <input id="m_title" placeholder="Obrigat√≥rio">

    <div style="height:8px"></div>
    <label>Autores</label>
    <input id="m_authors" placeholder="Ex.: Autor 1, Autor 2">

    <div style="height:8px"></div>
    <label>Editora</label>
    <input id="m_publisher">

    <div style="height:8px"></div>
    <label>Edi√ß√£o</label>
    <input id="m_edition">

    <div style="height:8px"></div>
    <label>Ano</label>
    <input id="m_year" inputmode="numeric">

    <div style="height:8px"></div>
    <label>Idioma</label>
    <input id="m_language" placeholder="pt-BR">

    <div style="height:8px"></div>
    <label>P√°ginas</label>
    <input id="m_pages" inputmode="numeric">

    <div style="height:8px"></div>
    <label>Link</label>
    <input id="m_link">

    <div style="height:8px"></div>
    <label>Localiza√ß√£o</label>
    <input id="m_location">

    <div style="height:8px"></div>
    <label>Observa√ß√µes</label>
    <textarea id="m_notes" rows="2"></textarea>

    <div class="row" style="margin-top:10px;">
      <button id="btnManual" onclick="cadastrarManual()">Salvar manual</button>
      <span id="m_status" class="small"></span>
    </div>
  </div>
</div>

<!-- ===== SCANNER ===== -->
<div id="scannerModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.75); padding:14px;">
  <div style="background:#fff; border-radius:14px; padding:14px; max-width:680px; margin:0 auto;">
    <div class="row" style="justify-content:space-between;">
      <b>Escanear ISBN</b>
      <button class="alt" onclick="fecharScanner()">Fechar</button>
    </div>
    <div class="small" style="margin:8px 0;">Aponte para o c√≥digo de barras (EAN-13).</div>
    <video id="video" style="width:100%; border-radius:12px; border:1px solid #ddd;" autoplay muted playsinline></video>
    <div class="small" id="scanStatus" style="margin-top:8px;"></div>
  </div>
</div>

<script type="module">
  import * as ZXing from "https://cdn.jsdelivr.net/npm/@zxing/browser@latest/+esm";
  window.ZXing = ZXing;
</script>

<script>
/* ================= CONFIG ================= */
const CLIENT_ID = "633125662554-rjlr69ihdv7g0njfgl9doacnsmdmkcbh.apps.googleusercontent.com";
const API_URL  = "https://script.google.com/macros/s/AKfycbyMm03BzNNkA5lNbsXBb4CH6cBasRRYO-gtDRkTgUwuULQrjHi1U_YqqBmxwO2AgSAm/exec";

let ID_TOKEN = "";
let ME = { email:"", role:"" };

let OFFSET = 0;
const LIMIT = 50;
let codeReader = null;

const $ = id => document.getElementById(id);

/* ================= TABS ================= */
function showTab(name){
  ["cad","acervo","users"].forEach(x => $(x).classList.add("hidden"));
  $(name).classList.remove("hidden");
}
showTab("cad");

/* ================= LOGIN ================= */
function initLogin() {
  const diag = msg => $("diag").textContent = msg;

  const showFallback = msg => {
    $("fallbackLogin").style.display = "inline-block";
    diag(msg);
  };

  const start = () => {
    try {
      diag("Inicializando login...");

      google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: async (resp) => {
          ID_TOKEN = resp.credential || "";
          $("authStatus").textContent = "‚úÖ Logado.";
          $("fallbackLogin").style.display = "none";
          diag("Token OK.");

          await loadMe();
          await carregarRecentes();
          buscar();
          $("isbn").focus();
        }
      });

      google.accounts.id.renderButton($("gsiBtn"), {
        theme:"outline",
        size:"large",
        text:"signin_with"
      });

      setTimeout(() => {
        if (!$("gsiBtn").innerHTML.trim()) {
          showFallback("Bot√£o padr√£o n√£o renderizou. Use o alternativo.");
        } else {
          diag("Bot√£o de login pronto.");
        }
      }, 900);

    } catch (e) {
      showFallback("Erro ao iniciar login.");
    }
  };

  const t0 = Date.now();
  (function wait(){
    if (window.__gsiFailed) return showFallback("Falha ao carregar login do Google.");
    if (window.__gsiLoaded && window.google && google.accounts) return start();
    if (Date.now() - t0 > 4000) return showFallback("Login do Google n√£o carregou a tempo.");
    setTimeout(wait, 150);
  })();
}

function loginFallback() {
  try { google.accounts.id.prompt(); }
  catch { $("diag").textContent = "Falha ao abrir login."; }
}

/* ================= API JSONP ================= */
function api(action, payload = {}) {
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Date.now() + "_" + Math.random().toString(36).slice(2);
    window[cb] = data => { delete window[cb]; s.remove(); resolve(data); };

    const p = new URLSearchParams({ callback:cb, action, idToken:ID_TOKEN });

    if (payload.limit != null) p.set("limit", String(payload.limit));
    if (payload.offset != null) p.set("offset", String(payload.offset));
    if (payload.query != null) p.set("query", String(payload.query));
    if (payload.isbn != null) p.set("isbn", String(payload.isbn));

    if (payload.extras != null) p.set("extras", encodeURIComponent(JSON.stringify(payload.extras)));
    if (payload.payload != null) p.set("payload", encodeURIComponent(JSON.stringify(payload.payload)));
    if (payload.user != null) p.set("user", encodeURIComponent(JSON.stringify(payload.user)));

    const s = document.createElement("script");
    s.src = API_URL + "?" + p.toString();
    s.onerror = () => reject(new Error("Falha ao chamar API."));
    document.body.appendChild(s);
  });
}

/* ================= ME / ROLE UI ================= */
async function loadMe(){
  const r = await api("me");
  if (!r || !r.ok) {
    ME = { email:"", role:"" };
    $("rolePill").textContent = "sem acesso";
    $("btnCadastrar").disabled = true;
    $("btnManual").disabled = true;
    $("usersGate").textContent = "Sem permiss√£o (seu e-mail n√£o est√° ativo em USERS).";
    return;
  }
  ME = { email:r.email, role:r.role };
  $("rolePill").textContent = `${ME.role}`;
  const canEdit = (ME.role === "admin" || ME.role === "editor");
  $("btnCadastrar").disabled = !canEdit;
  $("btnManual").disabled = !canEdit;

  if (ME.role === "admin") {
    $("usersGate").textContent = "Admin: voc√™ pode gerenciar usu√°rios aqui.";
    $("usersAdmin").classList.remove("hidden");
    await loadUsers();
  } else {
    $("usersGate").textContent = "Voc√™ n√£o √© admin. Apenas consulta.";
    $("usersAdmin").classList.add("hidden");
  }
}

/* ================= CADASTRO ISBN ================= */
$("isbn").addEventListener("keydown", e => { if (e.key === "Enter") cadastrar(); });

function setStatus(msg, loading=false){
  $("status").textContent = msg || "";
  $("btnCadastrar").disabled = loading || !(ME.role==="admin"||ME.role==="editor");
}

async function cadastrar() {
  if (!ID_TOKEN) return setStatus("Fa√ßa login antes.");
  if (!(ME.role==="admin"||ME.role==="editor")) return setStatus("Sem permiss√£o para cadastrar.");

  const isbn = $("isbn").value.trim();
  if (!/^\d{13}$/.test(isbn)) return setStatus("ISBN inv√°lido (13 d√≠gitos).");

  setStatus("Buscando...", true);
  try {
    const extras = { location:$("location").value.trim(), notes:$("notes").value.trim() };
    const r = await api("cadastrar", { isbn, extras });
    if (!r || !r.ok) return setStatus(r?.message || "Falhou.");
    setStatus("‚úÖ Cadastrado!");
    $("isbn").value = "";
    await carregarRecentes();
    buscar();
  } catch(e) {
    setStatus("Erro: " + (e?.message || e));
  }
}

/* ================= CADASTRO MANUAL ================= */
function openManual(){
  if (!(ME.role==="admin"||ME.role==="editor")) { setStatus("Sem permiss√£o para cadastro manual."); return; }
  $("manualModal").style.display = "block";
  $("m_status").textContent = "";
}
function closeManual(){ $("manualModal").style.display = "none"; }

async function cadastrarManual(){
  if (!(ME.role==="admin"||ME.role==="editor")) { $("m_status").textContent="Sem permiss√£o."; return; }

  const payload = {
    title: $("m_title").value.trim(),
    authors: $("m_authors").value.trim(),
    publisher: $("m_publisher").value.trim(),
    edition: $("m_edition").value.trim(),
    year: $("m_year").value.trim(),
    language: $("m_language").value.trim(),
    pages: $("m_pages").value.trim(),
    link: $("m_link").value.trim(),
    location: $("m_location").value.trim(),
    notes: $("m_notes").value.trim()
  };
  if (!payload.title) { $("m_status").textContent="T√≠tulo √© obrigat√≥rio."; return; }

  $("m_status").textContent="Salvando...";
  try {
    const r = await api("cadastrar_manual", { payload });
    if (!r || !r.ok) { $("m_status").textContent = r?.message || "Falhou."; return; }
    $("m_status").textContent = `‚úÖ Salvo (${r.id})`;
    closeManual();
    await carregarRecentes();
    buscar();
  } catch(e) {
    $("m_status").textContent="Erro: " + (e?.message || e);
  }
}

/* ================= RECENTES ================= */
async function carregarRecentes() {
  if (!ID_TOKEN) return;
  const r = await api("recentes", { limit: 20 });
  const el = $("recentes");
  el.innerHTML = "";
  (r.items || []).forEach(it => {
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML =
      `<b>${esc(it.title||"(sem t√≠tulo)")}</b>
       <div class="small">${esc(it.authors||"")}</div>
       <div class="small">ID: ${esc(it.id||"")} ¬∑ ${esc(it.publisher||"")} ¬∑ ${esc(it.year||"")} ¬∑ ${esc(it.source||"")}</div>`;
    el.appendChild(div);
  });
}

/* ================= ACERVO ================= */
function buscar(){ OFFSET = 0; carregarPagina(); }

async function carregarPagina(){
  const r = await api("buscar", { query: $("q").value.trim(), offset: OFFSET, limit: LIMIT });
  $("resumo").textContent = `Total: ${r.total || 0} | P√°gina: ${Math.floor(OFFSET/LIMIT)+1}`;
  const el = $("acervoList"); el.innerHTML = "";
  (r.items||[]).forEach(it => {
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML =
      `<b>${esc(it.title||"(sem t√≠tulo)")}</b>
       <div class="small">${esc(it.authors||"")}</div>
       <div class="small">ID: ${esc(it.id||"")} ¬∑ ${esc(it.publisher||"")} ¬∑ ${esc(it.year||"")} ¬∑ ${esc(it.location||"")}</div>`;
    el.appendChild(div);
  });
}
function next(){ OFFSET += LIMIT; carregarPagina(); }
function prev(){ OFFSET = Math.max(0, OFFSET-LIMIT); carregarPagina(); }

/* ================= USERS (ADMIN) ================= */
async function loadUsers(){
  $("u_status").textContent = "";
  const list = $("usersList");
  list.innerHTML = "";
  try {
    const r = await api("users_list");
    if (!r || !r.ok) { list.innerHTML = `<div class="small">Falhou: ${esc(r?.message||"")}</div>`; return; }

    (r.users||[]).forEach(u => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <b>${esc(u.email)}</b> <span class="pill">${esc(u.role)}</span> <span class="pill">${u.active ? "ativo" : "inativo"}</span>
        <div class="small">${esc(u.name||"")}</div>
        <div class="row" style="margin-top:8px;">
          <button class="alt" onclick='fillUser(${JSON.stringify(u).replace(/'/g,"&#39;")})'>Editar</button>
        </div>
      `;
      list.appendChild(div);
    });
  } catch(e) {
    list.innerHTML = `<div class="small">Erro: ${esc(e?.message||e)}</div>`;
  }
}

function fillUser(u){
  $("u_email").value = u.email || "";
  $("u_name").value = u.name || "";
  $("u_role").value = u.role || "viewer";
  $("u_active").checked = !!u.active;
  $("u_status").textContent = "Pronto para salvar.";
}

async function upsertUser(){
  const email = $("u_email").value.trim().toLowerCase();
  const name = $("u_name").value.trim();
  const role = $("u_role").value;
  const active = $("u_active").checked;

  if (!email.includes("@")) { $("u_status").textContent = "Email inv√°lido."; return; }

  $("u_status").textContent = "Salvando...";
  try {
    const r = await api("users_upsert", { user: { email, name, role, active } });
    if (!r || !r.ok) { $("u_status").textContent = r?.message || "Falhou."; return; }
    $("u_status").textContent = `‚úÖ ${r.action} (linha ${r.row})`;
    await loadUsers();
  } catch(e) {
    $("u_status").textContent = "Erro: " + (e?.message || e);
  }
}

/* ================= SCANNER ================= */
async function abrirScanner() {
  if (!(ME.role==="admin"||ME.role==="editor")) return setStatus("Sem permiss√£o para escanear/cadastrar.");
  $("scannerModal").style.display = "block";
  $("scanStatus").textContent = "Abrindo c√¢mera...";

  if (!window.ZXing) { $("scanStatus").textContent = "Scanner n√£o carregou. Recarregue."; return; }

  try {
    codeReader = new window.ZXing.BrowserMultiFormatReader();
    const video = $("video");
    const devices = await window.ZXing.BrowserCodeReader.listVideoInputDevices();
    const backCam = devices.find(d => /back|traseira|rear/i.test(d.label)) || devices[0];

    await codeReader.decodeFromVideoDevice(backCam?.deviceId, video, (result) => {
      if (result) {
        const raw = result.getText().replace(/\D/g, "");
        if (raw.length !== 13) return;
        $("isbn").value = raw;
        $("scanStatus").textContent = "‚úÖ Detectado";
        fecharScanner();
        $("isbn").focus();
      }
    });

    $("scanStatus").textContent = "Aponte para o c√≥digo...";
  } catch(e) {
    $("scanStatus").textContent = "Erro c√¢mera: " + (e?.message || e);
  }
}

function fecharScanner() {
  $("scannerModal").style.display = "none";
  try { codeReader && codeReader.reset(); } catch(e){}
  codeReader = null;
}

/* ================= HELPERS ================= */
function esc(s){ return String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])); }

/* ================= START ================= */
initLogin();
</script>

</body>
</html>
