<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Biblioteca - Fam√≠lia Batista</title>

  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Identity -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: #f5f6f8;
      margin: 0;
      padding: 12px;
    }

    h1 {
      font-size: 20px;
      margin: 0 0 10px 0;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 14px;
      box-shadow: 0 1px 3px rgba(0,0,0,.08);
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    input, textarea, button, select {
      font-size: 15px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
    }

    input, textarea {
      flex: 1;
      min-width: 0;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    button {
      cursor: pointer;
      background: #000;
      color: #fff;
      border: none;
    }

    button.secondary {
      background: #eee;
      color: #000;
    }

    .muted {
      color: #666;
      font-size: 13px;
    }

    .hidden {
      display: none;
    }

    .nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: space-around;
      padding: 8px 0;
    }

    .nav button {
      background: none;
      color: #000;
      font-size: 14px;
    }

    .tile-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
    }

    .tile {
      background: #fff;
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,.1);
      cursor: pointer;
    }

    .tile img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 8px;
      background: #eee;
    }

    .tile b {
      display: block;
      margin-top: 6px;
      font-size: 14px;
    }

    .tile span {
      font-size: 13px;
      color: #666;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    .modal {
      background: #fff;
      width: 95%;
      max-width: 520px;
      max-height: 90vh;
      overflow-y: auto;
      border-radius: 14px;
      padding: 16px;
    }
  </style>
</head>

<body>

  <h1>üìö Biblioteca - Fam√≠lia Batista</h1>
  <div id="status" class="muted">Carregando...</div>

  <!-- ACESSO -->
  <div class="card" id="cardLogin">
    <b>Acesso</b>
    <p class="muted">Fa√ßa login para usar.</p>

    <!-- GOOGLE LOGIN -->
    <div id="gsiBtn" style="margin:10px 0;min-height:44px;"></div>

    <!-- EMAIL + PIN -->
    <div style="margin-top:10px;">
      <b>Ou entrar com Email + PIN</b>
      <div class="row" style="margin-top:6px;">
        <input id="pin_email" placeholder="email@exemplo.com" autocomplete="username email">
        <input id="pin_code"
               placeholder="PIN"
               type="password"
               inputmode="numeric"
               autocomplete="current-password">
        <button onclick="loginPin()">Entrar</button>
      </div>
    </div>

    <div style="margin-top:10px;">
      <label>
        <input type="checkbox" id="rememberMe" checked>
        Permanecer logado neste dispositivo
      </label>
    </div>
  </div>

  <!-- CADASTRO -->
  <div class="card hidden" id="cardCadastro">
    <b>Cadastrar</b>
    <p class="muted">Por ISBN ou manual.</p>

    <input id="isbn" placeholder="ISBN (13 d√≠gitos)">
    <input id="location" placeholder="Localiza√ß√£o (opcional)">
    <textarea id="notes" placeholder="Observa√ß√µes (opcional)"></textarea>

    <div class="row">
      <button onclick="cadastrar()">Cadastrar</button>
      <button class="secondary" onclick="cadastroManual()">‚úçÔ∏è Manual</button>
    </div>
  </div>

  <!-- ACERVO -->
  <div class="card hidden" id="cardAcervo">
    <b>Acervo</b>
    <input id="search" placeholder="Buscar..." oninput="buscar()">
    <div id="grid" class="tile-grid"></div>
  </div>

  <!-- MODAL -->
  <div class="overlay hidden" id="overlay">
    <div class="modal" id="modal"></div>
  </div>

  <!-- NAVEGA√á√ÉO -->
  <div class="nav hidden" id="nav">
    <button onclick="show('cardCadastro')">Cadastrar</button>
    <button onclick="show('cardAcervo')">Acervo</button>
    <button onclick="logout()">Sair</button>
  </div>

<script>
/* ================== CONFIG ================== */
const API = "https://script.google.com/macros/s/SEU_DEPLOY_AQUI/exec";
let SESSION = null;

/* ================== LOGIN GOOGLE ================== */
function initGoogle() {
  if (!window.google || !google.accounts) return;

  google.accounts.id.initialize({
    client_id: "SEU_CLIENT_ID_GOOGLE.apps.googleusercontent.com",
    callback: onGoogleLogin
  });

  google.accounts.id.renderButton(
    document.getElementById("gsiBtn"),
    { theme: "outline", size: "large" }
  );
}

function onGoogleLogin(res) {
  authenticate({ idToken: res.credential });
}

/* ================== LOGIN PIN ================== */
function loginPin() {
  authenticate({
    email: document.getElementById("pin_email").value,
    pin: document.getElementById("pin_code").value
  });
}

/* ================== AUTH ================== */
function authenticate(data) {
  fetch(API + "?action=login", {
    method: "POST",
    body: JSON.stringify(data)
  })
  .then(r => r.json())
  .then(r => {
    if (!r.ok) return alert(r.message);
    SESSION = r;
    document.getElementById("status").innerText =
      "Logado: " + r.email + " (" + r.role + ")";
    document.getElementById("cardLogin").classList.add("hidden");
    document.getElementById("nav").classList.remove("hidden");
    document.getElementById("cardCadastro").classList.remove("hidden");
    document.getElementById("cardAcervo").classList.remove("hidden");
    buscar();
  });
}

/* ================== UI ================== */
function show(id) {
  ["cardCadastro","cardAcervo"].forEach(x =>
    document.getElementById(x).classList.add("hidden")
  );
  document.getElementById(id).classList.remove("hidden");
}

function logout() {
  SESSION = null;
  location.reload();
}

/* ================== ACERVO ================== */
function buscar() {
  fetch(API + "?action=buscar&query=" + encodeURIComponent(search.value))
    .then(r=>r.json())
    .then(r=>{
      const g = document.getElementById("grid");
      g.innerHTML="";
      r.items.forEach(it=>{
        const d=document.createElement("div");
        d.className="tile";
        d.innerHTML=`
          <img src="${it.capa || ''}" onerror="this.src='';this.alt='Sem capa'">
          <b>${it.title||"(sem t√≠tulo)"}</b>
          <span>${it.authors||""}</span>
        `;
        g.appendChild(d);
      });
    });
}

/* ================== CADASTRO ================== */
function cadastrar() {
  fetch(API + "?action=cadastrar", {
    method:"POST",
    body: JSON.stringify({
      isbn:isbn.value,
      extras:{ location:location.value, notes:notes.value }
    })
  })
  .then(r=>r.json())
  .then(r=>{
    alert(r.message || "Conclu√≠do");
    buscar();
  });
}

function cadastroManual() {
  alert("Cadastro manual ser√° aberto aqui.");
}

/* ================== START ================== */
window.onload = () => {
  initGoogle();
  document.getElementById("status").innerText = "";
};
</script>

</body>
</html>
