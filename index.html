<!doctype html>
<html lang="pt-BR">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial; margin:0; background:#f5f6f8; }
    .topbar { position:sticky; top:0; background:#fff; padding:14px 16px; border-bottom:1px solid #e6e6e6; z-index:10; }
    .title { font-size:18px; font-weight:700; }
    .sub { font-size:12px; color:#666; margin-top:2px; }
    .wrap { padding:14px 14px 82px; }
    .card { background:#fff; border:1px solid #e6e6e6; border-radius:16px; padding:14px; margin-bottom:12px; }
    input, textarea, select { width:100%; padding:10px; border-radius:12px; border:1px solid #d7d7d7; font-size:16px; box-sizing:border-box; }
    button { padding:10px 14px; border-radius:12px; border:1px solid #333; background:#111; color:#fff; font-size:16px; cursor:pointer; }
    button.alt { background:#fff; color:#111; border-color:#bbb; }
    button:disabled { opacity:.6; cursor:default; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .small { color:#666; font-size:13px; }
    .hidden { display:none !important; }
    .rememberRow{ display:flex; align-items:center; gap:10px; width:100%; }
    .rememberRow input{ width:20px; height:20px; flex:0 0 auto; }
    .rememberRow span{ flex:1 1 auto; white-space:normal; word-break:break-word; }
    .nav { position:fixed; left:0; right:0; bottom:0; background:#fff; border-top:1px solid #e6e6e6; display:flex; }
    .nav button { flex:1; border:none; border-radius:0; background:#fff; color:#111; padding:12px 6px; font-size:13px; }
    .nav button.active { font-weight:700; }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid #ddd; font-size:12px; color:#444; background:#fafafa; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:12px; margin-top:12px; }
    .tile { border:1px solid #e6e6e6; border-radius:16px; overflow:hidden; background:#fff; cursor:pointer; }
    .cover { width:100%; aspect-ratio: 3/4; background:#eef0f3; display:flex; align-items:center; justify-content:center; color:#666; font-size:13px; }
    .cover img { width:100%; height:100%; object-fit:cover; display:block; }
    .tileBody { padding:10px; }
    .tTitle { font-weight:700; font-size:14px; line-height:1.2; }
    .tMeta { font-size:12px; color:#666; margin-top:6px; }
    #detailModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); padding:14px; z-index:40; }
    #detailBox { background:#fff; border-radius:16px; max-width:820px; margin:0 auto; max-height:90vh; overflow:auto; padding:12px; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="title">üìö Biblioteca - Fam√≠lia Batista</div>
    <div class="sub" id="topStatus">Aguardando login‚Ä¶</div>
  </div>

  <div class="wrap">

    <!-- Acesso -->
    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:flex-start;">
        <div>
          <b>Acesso</b>
          <div class="small" id="authStatus">Fa√ßa login para usar.</div>
        </div>
        <button id="btnLogout" class="alt" style="display:none" onclick="logout()">Sair</button>
      </div>

      <div class="small" style="margin-top:10px;"><b>Entrar com Email + PIN</b></div>
      <div class="row" style="margin-top:8px;">
        <input id="pinEmail" placeholder="email@exemplo.com" style="flex:2; min-width:220px;">
        <input id="pinCode" placeholder="PIN" style="flex:1; min-width:120px;" autocomplete="off">
        <button class="alt" onclick="loginPin()">Entrar</button>
      </div>
      <div class="small" id="pinMsg" style="margin-top:6px;"></div>

      <div class="small" style="margin-top:8px;">
        <label class="rememberRow">
          <input type="checkbox" id="remember" checked>
          <span>Permanecer logado neste dispositivo</span>
        </label>
      </div>
    </div>

    <!-- CADASTRAR -->
    <section id="screenCadastrar">
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <b>Cadastrar</b>
          <span class="pill" id="rolePill">‚Äî</span>
        </div>
        <div class="small">Por ISBN (digitando) ou manual (sem ISBN).</div>
      </div>

      <div class="card">
        <label><b>ISBN</b></label>
        <input id="isbn" inputmode="numeric" placeholder="Ex.: 9788576082675" autocomplete="off">

        <div style="height:10px"></div>
        <label><b>Localiza√ß√£o</b> <span class="small">(opcional)</span></label>
        <input id="location" placeholder="Ex.: Estante sala, prateleira 2">

        <div style="height:10px"></div>
        <label><b>Observa√ß√µes</b> <span class="small">(opcional)</span></label>
        <textarea id="notes" rows="2"></textarea>

        <div class="row" style="margin-top:10px;">
          <button id="btnCadastrar" onclick="cadastrar()">Cadastrar</button>
        </div>

        <div class="small" id="statusCadastrar" style="margin-top:8px;"></div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <b>√öltimos cadastrados</b>
          <button class="alt" onclick="carregarRecentes()">Atualizar</button>
        </div>
        <div id="recentes" class="grid"></div>
      </div>
    </section>

    <!-- ACERVO -->
    <section id="screenAcervo" class="hidden">
      <div class="card">
        <b>Acervo</b>
        <div class="small">Busque por t√≠tulo, autor, editora, ISBN, localiza√ß√£o‚Ä¶</div>

        <div class="row" style="margin-top:10px;">
          <input id="q" placeholder="Buscar...">
          <button class="alt" onclick="buscar(true)">Buscar</button>
        </div>

        <div class="small" id="resumo" style="margin-top:10px;"></div>
        <div id="acervo" class="grid"></div>

        <div class="row" style="margin-top:10px;">
          <button class="alt" onclick="prev()">‚óÄ</button>
          <button class="alt" onclick="next()">‚ñ∂</button>
        </div>
      </div>
    </section>

    <!-- USU√ÅRIOS (ADMIN) -->
    <section id="screenUsers" class="hidden">
      <div class="card">
        <b>Usu√°rios</b>
        <div class="small">Somente admin pode ver/editar.</div>
        <div class="small" id="usersStatus" style="margin-top:8px;"></div>
      </div>

      <div class="card" id="usersAdminCard">
        <b>Adicionar/Atualizar</b>

        <div style="height:10px"></div>
        <label><b>Email</b></label>
        <input id="u_email" placeholder="email@exemplo.com">

        <div style="height:10px"></div>
        <label><b>Role</b></label>
        <select id="u_role">
          <option value="viewer">viewer</option>
          <option value="editor">editor</option>
          <option value="admin">admin</option>
        </select>

        <div style="height:10px"></div>
        <label><b>Ativo</b></label>
        <select id="u_active">
          <option value="true">TRUE</option>
          <option value="false">FALSE</option>
        </select>

        <div style="height:10px"></div>
        <label><b>Nome</b> <span class="small">(opcional)</span></label>
        <input id="u_name" placeholder="Opcional">

        <div style="height:10px"></div>
        <label><b>PIN</b> <span class="small">(opcional ‚Äì deixe vazio para n√£o alterar)</span></label>
        <input id="u_pin" placeholder="Ex.: 1234" autocomplete="off">

        <div class="row" style="margin-top:10px;">
          <button class="alt" onclick="saveUser()">Salvar usu√°rio</button>
          <button class="alt" onclick="loadUsers()">Recarregar</button>
        </div>
      </div>

      <div class="card">
        <b>Lista</b>
        <div id="usersList"></div>
      </div>
    </section>

  </div>

  <!-- Bottom Nav -->
  <div class="nav">
    <button id="navCadastrar" class="active" onclick="showScreen('Cadastrar')">Cadastrar</button>
    <button id="navAcervo" onclick="showScreen('Acervo')">Acervo</button>
    <button id="navUsers" onclick="showScreen('Users')">Usu√°rios</button>
  </div>

  <!-- Detalhes modal -->
  <div id="detailModal">
    <div id="detailBox">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <b>Detalhes do livro</b>
        <button class="alt" onclick="closeDetail()">Fechar</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <div style="width:140px">
          <div class="cover" style="border-radius:12px; overflow:hidden;">
            <img id="d_coverImg" alt="capa" style="display:none;">
            <span id="d_coverPh">Sem capa</span>
          </div>

          <input id="d_coverFile" type="file" accept="image/*" capture="environment" class="hidden">
          <button id="btnCover" class="alt" style="margin-top:10px; width:100%;" onclick="pickCover()">üì∑ Enviar capa</button>
          <div class="small" id="d_coverMsg" style="margin-top:6px;"></div>
        </div>

        <div style="flex:1; min-width:240px;">
          <label><b>ID</b></label>
          <input id="d_id" disabled>

          <div style="height:10px"></div>
          <label><b>ISBN</b></label>
          <input id="d_isbn" disabled>

          <div style="height:10px"></div>
          <label><b>T√≠tulo</b></label>
          <input id="d_title">

          <div style="height:10px"></div>
          <label><b>Autor(es)</b></label>
          <input id="d_authors">

          <div style="height:10px"></div>
          <label><b>Editora</b></label>
          <input id="d_publisher">

          <div style="height:10px"></div>
          <label><b>Ano</b></label>
          <input id="d_year">

          <div style="height:10px"></div>
          <label><b>Link</b></label>
          <input id="d_link">

          <div style="height:10px"></div>
          <label><b>Localiza√ß√£o</b></label>
          <input id="d_location">

          <div style="height:10px"></div>
          <label><b>Observa√ß√µes</b></label>
          <textarea id="d_notes" rows="3"></textarea>

          <div class="row" style="margin-top:10px;">
            <button id="btnSaveDetail" onclick="saveDetail()">Salvar altera√ß√µes</button>
            <span class="small" id="d_msg"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL  = "https://script.google.com/macros/s/AKfycbyMm03BzNNkA5lNbsXBb4CH6cBasRRYO-gtDRkTgUwuULQrjHi1U_YqqBmxwO2AgSAm/exec";
    const STORAGE_KEY = "bib_auth_token_pin_v1";

    let AUTH_TOKEN = "";
    let ME = null;
    let OFFSET = 0;
    const LIMIT = 24;
    let CURRENT_ITEM = null;

    const $ = id => document.getElementById(id);

    function saveToken_(token){
      if (!$("remember").checked) return;
      try { localStorage.setItem(STORAGE_KEY, token); } catch(e) {}
    }
    function loadToken_(){
      try { return localStorage.getItem(STORAGE_KEY) || ""; } catch(e) { return ""; }
    }
    function clearToken_(){
      try { localStorage.removeItem(STORAGE_KEY); } catch(e) {}
    }

    function setTop(msg){ $("topStatus").textContent = msg; }

    function setLoggedOutUI_(msg){
      ME = null;
      AUTH_TOKEN = "";
      $("authStatus").textContent = msg || "Fa√ßa login para usar.";
      $("btnLogout").style.display = "none";
      $("rolePill").textContent = "‚Äî";
      setTop("N√£o autenticado.");
      $("navUsers").classList.add("hidden");
      $("usersAdminCard").classList.add("hidden");
      $("btnCadastrar").disabled = true;
      $("btnSaveDetail").disabled = true;
      $("btnCover").disabled = true;
    }

    function setLoggedInUI_(email, role){
      $("authStatus").textContent = "‚úÖ Logado.";
      $("btnLogout").style.display = "inline-block";
      $("rolePill").textContent = role;
      setTop(`Logado: ${email} (${role})`);

      const canEdit = (role === "admin" || role === "editor");
      $("btnCadastrar").disabled = !canEdit;
      $("btnSaveDetail").disabled = !canEdit;
      $("btnCover").disabled = !canEdit;

      if (role === "admin") {
        $("navUsers").classList.remove("hidden");
        $("usersAdminCard").classList.remove("hidden");
      } else {
        $("navUsers").classList.add("hidden");
        $("usersAdminCard").classList.add("hidden");
      }
    }

    function api(action, payload = {}) {
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Date.now() + "_" + Math.random().toString(36).slice(2);
        window[cb] = (data) => {
          try { delete window[cb]; } catch(e) {}
          script.remove();
          resolve(data);
        };

        const params = new URLSearchParams();
        params.set("callback", cb);
        params.set("action", action);
        if (AUTH_TOKEN) params.set("authToken", AUTH_TOKEN);

        if (payload.id != null) params.set("id", String(payload.id));
        if (payload.query != null) params.set("query", String(payload.query));
        if (payload.offset != null) params.set("offset", String(payload.offset));
        if (payload.limit != null) params.set("limit", String(payload.limit));
        if (payload.isbn != null) params.set("isbn", String(payload.isbn));
        if (payload.forceUpdate != null) params.set("forceUpdate", String(payload.forceUpdate));

        if (payload.extras != null) params.set("extras", encodeURIComponent(JSON.stringify(payload.extras)));
        if (payload.payload != null) params.set("payload", encodeURIComponent(JSON.stringify(payload.payload)));
        if (payload.user != null) params.set("user", encodeURIComponent(JSON.stringify(payload.user)));

        const script = document.createElement("script");
        script.src = API_URL + "?" + params.toString();
        script.onerror = () => {
          try { delete window[cb]; } catch(e) {}
          script.remove();
          reject(new Error("Falha ao chamar API (JSONP)."));
        };
        document.body.appendChild(script);
      });
    }

    async function validateToken_() {
      const me = await api("me");
      if (!me || !me.ok) throw new Error(me?.message || "Sem permiss√£o.");
      ME = { email: me.email, role: me.role };
      setLoggedInUI_(ME.email, ME.role);
      saveToken_(AUTH_TOKEN);

      await carregarRecentes();
      await buscar(true);
      if (ME.role === "admin") loadUsers();
    }

    async function loginPin() {
      const email = $("pinEmail").value.trim().toLowerCase();
      const pin = $("pinCode").value.trim();
      $("pinMsg").textContent = "Entrando‚Ä¶";

      const data = await new Promise((resolve, reject) => {
        const cb = "cb_" + Date.now() + "_" + Math.random().toString(36).slice(2);
        window[cb] = (out) => {
          try { delete window[cb]; } catch(e) {}
          script.remove();
          resolve(out);
        };
        const params = new URLSearchParams();
        params.set("callback", cb);
        params.set("action", "login_password");
        params.set("email", email);
        params.set("pin", pin);

        const script = document.createElement("script");
        script.src = API_URL + "?" + params.toString();
        script.onerror = () => { try { delete window[cb]; } catch(e) {} script.remove(); reject(new Error("Falha")); };
        document.body.appendChild(script);
      });

      if (!data || !data.ok) { $("pinMsg").textContent = data?.message || "Falhou."; return; }

      AUTH_TOKEN = data.sessionToken;
      $("pinMsg").textContent = "‚úÖ Logado (PIN).";
      try { await validateToken_(); }
      catch(e){ clearToken_(); setLoggedOutUI_("Sem acesso."); $("pinMsg").textContent = "Sem acesso."; }
    }

    function logout(){
      clearToken_();
      setLoggedOutUI_("Voc√™ saiu. Fa√ßa login para usar.");
    }

    function showScreen(name) {
      $("screenCadastrar").classList.toggle("hidden", name !== "Cadastrar");
      $("screenAcervo").classList.toggle("hidden", name !== "Acervo");
      $("screenUsers").classList.toggle("hidden", name !== "Users");

      $("navCadastrar").classList.toggle("active", name === "Cadastrar");
      $("navAcervo").classList.toggle("active", name === "Acervo");
      $("navUsers").classList.toggle("active", name === "Users");

      if (name === "Users" && ME && ME.role === "admin") loadUsers();
      if (name === "Acervo" && ME) buscar(true);
    }

    function setStatusCadastrar_(msg, loading=false){
      $("statusCadastrar").textContent = msg || "";
      $("btnCadastrar").disabled = !!loading || !(ME && (ME.role==="admin"||ME.role==="editor"));
    }

    async function cadastrar() {
      if (!ME) return setStatusCadastrar_("Fa√ßa login antes.");
      if (ME.role !== "admin" && ME.role !== "editor") return setStatusCadastrar_("Sem permiss√£o.");

      const isbn = $("isbn").value.trim();
      if (!/^\d{13}$/.test(isbn)) return setStatusCadastrar_("ISBN inv√°lido (13 d√≠gitos).");

      setStatusCadastrar_("Buscando‚Ä¶", true);

      const extras = { location: $("location").value.trim(), notes: $("notes").value.trim() };

      try {
        const res = await api("cadastrar", { isbn, extras });
        if (!res || !res.ok) return setStatusCadastrar_(res?.message || "Falhou.");

        if (res.action === "exists") {
          setStatusCadastrar_(res.message || "Item j√° cadastrado.");
          const ok = confirm(res.message || "Item j√° cadastrado. Deseja atualizar o cadastro?");
          if (ok) {
            setStatusCadastrar_("Atualizando‚Ä¶", true);
            const res2 = await api("cadastrar", { isbn, extras, forceUpdate: true });
            if (!res2 || !res2.ok) return setStatusCadastrar_(res2?.message || "Falhou.");
            setStatusCadastrar_("‚úÖ Atualizado.");
          } else {
            setStatusCadastrar_("‚úÖ Mantido sem altera√ß√µes.");
          }
        } else {
          setStatusCadastrar_("‚úÖ Cadastrado!");
        }

        $("isbn").value = "";
        await carregarRecentes();
        await buscar(true);

      } catch (e) {
        setStatusCadastrar_("Erro: " + (e?.message || e));
      } finally {
        $("btnCadastrar").disabled = !(ME && (ME.role==="admin"||ME.role==="editor"));
      }
    }

    function renderTile_(it) {
      const tile = document.createElement("div");
      tile.className = "tile";

      const cover = document.createElement("div");
      cover.className = "cover";
      if (it.coverUrl) {
        const img = document.createElement("img");
        img.src = it.coverUrl;
        cover.innerHTML = "";
        cover.appendChild(img);
      } else {
        cover.textContent = "Sem capa";
      }

      const body = document.createElement("div");
      body.className = "tileBody";

      const t = document.createElement("div");
      t.className = "tTitle";
      t.textContent = it.title || "(sem t√≠tulo)";

      const meta = document.createElement("div");
      meta.className = "tMeta";
      meta.textContent = `${it.authors || ""}`.trim();

      const meta2 = document.createElement("div");
      meta2.className = "tMeta";
      meta2.textContent = `${it.publisher || ""}${it.year ? " ¬∑ " + it.year : ""}`.trim();

      body.appendChild(t); body.appendChild(meta); body.appendChild(meta2);
      tile.appendChild(cover); tile.appendChild(body);

      tile.addEventListener("click", () => openDetail(it.id));
      return tile;
    }

    async function carregarRecentes() {
      if (!ME) return;
      const res = await api("recentes", { limit: 12 });
      const el = $("recentes");
      el.innerHTML = "";
      (res.items || []).forEach(it => el.appendChild(renderTile_(it)));
    }

    function buscar(reset=false){
      if (reset) OFFSET = 0;
      return carregarPagina();
    }

    async function carregarPagina(){
      if (!ME) return;
      const q = $("q").value.trim();
      const res = await api("buscar", { query: q, offset: OFFSET, limit: LIMIT });
      $("resumo").textContent = `Total: ${res.total || 0} | P√°gina: ${Math.floor(OFFSET / LIMIT) + 1}`;
      const el = $("acervo");
      el.innerHTML = "";
      (res.items || []).forEach(it => el.appendChild(renderTile_(it)));
    }

    function next(){ OFFSET += LIMIT; carregarPagina(); }
    function prev(){ OFFSET = Math.max(0, OFFSET - LIMIT); carregarPagina(); }

    async function openDetail(id) {
      if (!ME) return;

      $("detailModal").style.display = "block";
      $("d_msg").textContent = "Carregando‚Ä¶";
      $("d_coverMsg").textContent = "";
      CURRENT_ITEM = null;

      const res = await api("item_get", { id });
      if (!res || !res.ok) { $("d_msg").textContent = res?.message || "Erro."; return; }

      CURRENT_ITEM = res.item;
      fillDetail_(CURRENT_ITEM);
      $("d_msg").textContent = "";
    }

    function fillDetail_(it) {
      $("d_id").value = it["ID"] || "";
      $("d_isbn").value = it["ISBN"] || "";
      $("d_title").value = it["T√≠tulo"] || "";
      $("d_authors").value = it["Autor(es)"] || "";
      $("d_publisher").value = it["Editora"] || "";
      $("d_year").value = it["Ano"] || "";
      $("d_link").value = it["Link"] || "";
      $("d_location").value = it["Localiza√ß√£o"] || "";
      $("d_notes").value = it["Observa√ß√µes"] || "";

      const coverUrl = it["Capa_URL"] || "";
      const img = $("d_coverImg");
      const ph = $("d_coverPh");
      if (coverUrl) {
        img.src = coverUrl;
        img.style.display = "block";
        ph.style.display = "none";
      } else {
        img.style.display = "none";
        ph.style.display = "block";
      }

      const canEdit = (ME.role === "admin" || ME.role === "editor");
      ["d_title","d_authors","d_publisher","d_year","d_link","d_location","d_notes"].forEach(id => $(id).disabled = !canEdit);
      $("btnSaveDetail").disabled = !canEdit;
      $("btnCover").disabled = !canEdit;
    }

    function closeDetail() {
      $("detailModal").style.display = "none";
      CURRENT_ITEM = null;
    }

    async function saveDetail() {
      if (!ME || !CURRENT_ITEM) return;
      if (!(ME.role === "admin" || ME.role === "editor")) return;

      const id = $("d_id").value.trim();
      const updates = {
        "T√≠tulo": $("d_title").value.trim(),
        "Autor(es)": $("d_authors").value.trim(),
        "Editora": $("d_publisher").value.trim(),
        "Ano": $("d_year").value.trim(),
        "Link": $("d_link").value.trim(),
        "Localiza√ß√£o": $("d_location").value.trim(),
        "Observa√ß√µes": $("d_notes").value.trim()
      };

      $("d_msg").textContent = "Salvando‚Ä¶";
      $("btnSaveDetail").disabled = true;

      const res = await api("item_update", { payload: { id, updates } });
      if (!res || !res.ok) { $("d_msg").textContent = res?.message || "Erro."; $("btnSaveDetail").disabled=false; return; }

      $("d_msg").textContent = "‚úÖ Salvo.";
      $("btnSaveDetail").disabled = false;

      await carregarRecentes();
      await buscar(false);
    }

    function pickCover() {
      if (!ME || !(ME.role === "admin" || ME.role === "editor")) return;
      $("d_coverFile").click();
    }

    $("d_coverFile").addEventListener("change", async () => {
      const file = $("d_coverFile").files && $("d_coverFile").files[0];
      if (!file || !CURRENT_ITEM) return;

      $("d_coverMsg").textContent = "Enviando capa‚Ä¶";
      $("btnCover").disabled = true;

      try {
        const dataUrl = await fileToDataUrl_(file);
        const id = $("d_id").value.trim();

        const res = await api("cover_upload", { payload: { id, dataUrl } });
        if (!res || !res.ok) { $("d_coverMsg").textContent = res?.message || "Erro."; return; }

        $("d_coverImg").src = res.coverUrl;
        $("d_coverImg").style.display = "block";
        $("d_coverPh").style.display = "none";
        $("d_coverMsg").textContent = "‚úÖ Capa atualizada.";

        await carregarRecentes();
        await buscar(false);

      } catch(e) {
        $("d_coverMsg").textContent = "Erro: " + (e?.message || e);
      } finally {
        $("btnCover").disabled = !(ME && (ME.role==="admin"||ME.role==="editor"));
        $("d_coverFile").value = "";
      }
    });

    function fileToDataUrl_(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(String(r.result || ""));
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    async function loadUsers() {
      if (!ME || ME.role !== "admin") { $("usersStatus").textContent = "Sem permiss√£o."; return; }
      $("usersStatus").textContent = "Carregando‚Ä¶";
      const res = await api("users_list");
      if (!res || !res.ok) { $("usersStatus").textContent = res?.message || "Erro."; return; }
      $("usersStatus").textContent = "OK.";

      const list = $("usersList");
      list.innerHTML = "";
      (res.users || []).forEach(u => {
        const div = document.createElement("div");
        div.className = "small";
        div.style.padding = "10px 0";
        div.style.borderBottom = "1px solid #eee";
        div.textContent = `${u.email} | ${u.role} | active=${u.active ? "TRUE":"FALSE"} | ${u.name || ""}`;
        div.onclick = () => {
          $("u_email").value = u.email;
          $("u_role").value = u.role || "viewer";
          $("u_active").value = u.active ? "true" : "false";
          $("u_name").value = u.name || "";
          $("u_pin").value = "";
        };
        list.appendChild(div);
      });
    }

    async function saveUser() {
      if (!ME || ME.role !== "admin") return;

      const user = {
        email: $("u_email").value.trim().toLowerCase(),
        role: $("u_role").value,
        active: $("u_active").value === "true",
        name: $("u_name").value.trim()
      };
      const pin = $("u_pin").value.trim();
      if (pin) user.pin = pin;

      if (!user.email.includes("@")) { $("usersStatus").textContent = "Email inv√°lido."; return; }

      $("usersStatus").textContent = "Salvando‚Ä¶";
      const res = await api("users_upsert", { user });
      if (!res || !res.ok) { $("usersStatus").textContent = res?.message || "Erro."; return; }

      $("usersStatus").textContent = `‚úÖ ${res.action}`;
      await loadUsers();
    }

    // BOOT
    setLoggedOutUI_("Fa√ßa login para usar.");
    showScreen("Cadastrar");

    // tenta sess√£o salva
    (async () => {
      const saved = loadToken_();
      if (!saved) return;
      AUTH_TOKEN = saved;
      try { await validateToken_(); }
      catch(e){ clearToken_(); setLoggedOutUI_("Sess√£o expirada. Fa√ßa login novamente."); }
    })();
  </script>
</body>
</html>
