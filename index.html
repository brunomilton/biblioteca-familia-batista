<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Biblioteca - Fam√≠lia Batista</title>

  <script>
    window.__gsiLoaded = false;
    window.__gsiFailed = false;
    function __onGsiLoad(){ window.__gsiLoaded = true; }
    function __onGsiError(){ window.__gsiFailed = true; }
  </script>
  <script src="https://accounts.google.com/gsi/client" onload="__onGsiLoad()" onerror="__onGsiError()"></script>

  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial;margin:0;background:#f5f6f8}
    .topbar{position:sticky;top:0;background:#fff;padding:14px 16px;border-bottom:1px solid #e6e6e6;z-index:10}
    .title{font-size:18px;font-weight:700}
    .sub{font-size:12px;color:#666;margin-top:2px}
    .wrap{padding:14px 14px 82px}
    .card{background:#fff;border:1px solid #e6e6e6;border-radius:16px;padding:14px;margin-bottom:12px}
    input,textarea,select{width:100%;padding:10px;border-radius:12px;border:1px solid #d7d7d7;font-size:16px;box-sizing:border-box}
    button{padding:10px 14px;border-radius:12px;border:1px solid #333;background:#111;color:#fff;font-size:16px}
    button.alt{background:#fff;color:#111;border-color:#bbb}
    button:disabled{opacity:.6}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .small{color:#666;font-size:13px}
    .hidden{display:none!important}

    .nav{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #e6e6e6;display:flex}
    .nav button{flex:1;border:none;border-radius:0;background:#fff;color:#111;padding:12px 6px;font-size:13px}
    .nav button.active{font-weight:700}

    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #ddd;font-size:12px;color:#444;background:#fafafa}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-top:12px}
    .tile{background:#fff;border:1px solid #eee;border-radius:14px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.06);cursor:pointer}
    .cover{width:100%;height:190px;background:#eee;display:flex;align-items:center;justify-content:center;font-size:12px;color:#666}
    .cover img{width:100%;height:100%;object-fit:cover;display:block}
    .tileBody{padding:10px}
    .tileTitle{font-weight:700;font-size:13px;line-height:1.2}
    .tileMeta{margin-top:6px;font-size:12px;color:#666;line-height:1.2}

    #modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);padding:14px;z-index:50}
    #modalBox{background:#fff;border-radius:16px;max-width:720px;margin:0 auto;max-height:88vh;overflow:auto;padding:14px}
    #modalHeader{display:flex;justify-content:space-between;align-items:center;gap:10px;position:sticky;top:0;background:#fff;padding-bottom:10px;z-index:5}
    #modalHeader b{font-size:16px}
    .field{margin-top:10px}

    #scannerModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);padding:14px;z-index:60}
    #scannerBox{background:#fff;border-radius:16px;padding:12px;max-width:720px;margin:0 auto}
    #video{width:100%;border-radius:14px;border:1px solid #ddd;background:#000}

    .rememberRow{display:flex;align-items:center;gap:10px;width:100%}
    .rememberRow input{width:20px;height:20px;flex:0 0 auto}
    .rememberRow span{flex:1 1 auto;white-space:normal;word-break:break-word}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="title">üìö Biblioteca - Fam√≠lia Batista</div>
    <div class="sub" id="topStatus">Carregando‚Ä¶</div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:flex-start;">
        <div>
          <b>Acesso</b>
          <div class="small" id="authStatus">Fa√ßa login para usar.</div>
        </div>
        <div class="row">
          <button id="btnLogout" class="alt" style="display:none" onclick="logout()">Sair</button>
        </div>
      </div>

      <div id="gsiBtn" style="margin-top:8px; min-height:44px;"></div>

      <button id="fallbackLogin" class="alt" style="display:none; margin-top:8px;" onclick="loginFallback()">
        Entrar com Google
      </button>

      <div class="small" style="margin-top:10px"><b>Ou entrar com Email + PIN</b></div>
      <div class="row" style="margin-top:8px">
        <input id="pin_email" placeholder="email@exemplo.com" autocomplete="username email">
        <input id="pin_code" placeholder="PIN" type="password" inputmode="numeric" autocomplete="current-password">
        <button class="alt" onclick="loginPin()">Entrar</button>
      </div>

      <div class="small" style="margin-top:10px;">
        <label class="rememberRow">
          <input type="checkbox" id="remember" checked>
          <span>Permanecer logado neste dispositivo</span>
        </label>
      </div>

      <div id="diag" class="small" style="margin-top:8px;"></div>
    </div>

    <section id="screenCadastrar">
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <b>Cadastrar</b>
          <span class="pill" id="rolePill">‚Äî</span>
        </div>
        <div class="small">Por ISBN (digitando ou scanner) ou manual (sem ISBN).</div>
      </div>

      <div class="card">
        <label><b>ISBN</b></label>
        <input id="isbn" inputmode="numeric" placeholder="Ex.: 9788576082675" autocomplete="off">
        <div style="height:10px"></div>

        <label><b>Localiza√ß√£o</b> <span class="small">(opcional)</span></label>
        <input id="location" placeholder="Ex.: Estante sala, prateleira 2">
        <div style="height:10px"></div>

        <label><b>Observa√ß√µes</b> <span class="small">(opcional)</span></label>
        <textarea id="notes" rows="2"></textarea>

        <div class="row" style="margin-top:10px;">
          <button id="btnCadastrar" onclick="cadastrar()">Cadastrar</button>
          <button class="alt" onclick="abrirScanner()">üì∑ Escanear ISBN</button>
        </div>

        <div class="small" id="statusCadastrar" style="margin-top:8px;"></div>
      </div>
    </section>

    <section id="screenAcervo" class="hidden">
      <div class="card">
        <b>Acervo</b>
        <div class="small">Busque por t√≠tulo, autor, editora, ID/ISBN, ano, localiza√ß√£o‚Ä¶</div>

        <div class="row" style="margin-top:10px;">
          <input id="q" placeholder="Buscar...">
          <button class="alt" onclick="buscar()">Buscar</button>
        </div>

        <div class="small" id="resumo" style="margin-top:10px;"></div>
        <div id="grid" class="grid"></div>

        <div class="row" style="margin-top:10px;">
          <button class="alt" onclick="prev()">‚óÄ</button>
          <button class="alt" onclick="next()">‚ñ∂</button>
        </div>
      </div>
    </section>
  </div>

  <div class="nav">
    <button id="navCadastrar" class="active" onclick="showScreen('Cadastrar')">Cadastrar</button>
    <button id="navAcervo" onclick="showScreen('Acervo')">Acervo</button>
  </div>

  <div id="scannerModal">
    <div id="scannerBox">
      <div class="row" style="justify-content:space-between;">
        <b>Escanear ISBN</b>
        <button class="alt" onclick="fecharScanner()">Fechar</button>
      </div>
      <div class="small" style="margin:8px 0;">Aponte para o c√≥digo de barras (EAN-13).</div>
      <video id="video" autoplay muted playsinline></video>
      <div class="small" id="scanStatus" style="margin-top:8px;"></div>
    </div>
  </div>

  <div id="modal">
    <div id="modalBox">
      <div id="modalHeader">
        <b id="m_titleTop">Livro</b>
        <button class="alt" onclick="closeModal()">Fechar</button>
      </div>

      <div id="m_coverBox" class="field"></div>

      <div class="field"><label><b>ID</b></label><input id="m_id" disabled></div>
      <div class="field"><label><b>ISBN</b></label><input id="m_isbn" disabled></div>
      <div class="field"><label><b>T√≠tulo</b></label><input id="m_title"></div>
      <div class="field"><label><b>Autor(es)</b></label><input id="m_authors"></div>
      <div class="field"><label><b>Editora</b></label><input id="m_publisher"></div>
      <div class="field"><label><b>Edi√ß√£o</b></label><input id="m_edition"></div>

      <div class="row field">
        <div style="flex:1"><label><b>Ano</b></label><input id="m_year"></div>
        <div style="flex:1"><label><b>Idioma</b></label><input id="m_lang"></div>
      </div>

      <div class="field"><label><b>P√°ginas</b></label><input id="m_pages"></div>
      <div class="field"><label><b>Fonte</b></label><input id="m_source" disabled></div>
      <div class="field"><label><b>Link</b></label><input id="m_link"></div>
      <div class="field"><label><b>Capa_URL</b></label><input id="m_cover"></div>
      <div class="field"><label><b>Localiza√ß√£o</b></label><input id="m_location"></div>
      <div class="field"><label><b>Observa√ß√µes</b></label><textarea id="m_notes" rows="4"></textarea></div>

      <div class="row field">
        <button id="btnSaveItem" onclick="saveItem()">Salvar altera√ß√µes</button>
        <span class="small" id="m_status"></span>
      </div>
    </div>
  </div>

  <!-- ZXing fallback -->
  <script type="module">
    import * as ZXing from "https://cdn.jsdelivr.net/npm/@zxing/browser@latest/+esm";
    window.ZXing = ZXing;
  </script>

  <script>
    const CLIENT_ID = "633125662554-rjlr69ihdv7g0njfgl9doacnsmdmkcbh.apps.googleusercontent.com";
    const API_URL  = "https://script.google.com/macros/s/AKfycbyMm03BzNNkA5lNbsXBb4CH6cBasRRYO-gtDRkTgUwuULQrjHi1U_YqqBmxwO2AgSAm/exec";

    const STORAGE_KEY = "bib_session_v3";
    let ID_TOKEN = "";
    let PIN_SESSION = "";
    let ME = null;

    let OFFSET = 0;
    const LIMIT = 30;

    const $ = id => document.getElementById(id);
    function diag(msg){ $("diag").textContent = msg || ""; }
    function setTop(msg){ $("topStatus").textContent = msg || ""; }

    function saveSession_(){
      if (!$("remember").checked) return;
      const obj = { idToken: ID_TOKEN, session: PIN_SESSION };
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); } catch(e){}
    }
    function loadSession_(){
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "null"); } catch(e){ return null; }
    }
    function clearSession_(){
      try { localStorage.removeItem(STORAGE_KEY); } catch(e){}
    }

    function setLoggedOutUI_(msg){
      ME = null; ID_TOKEN = ""; PIN_SESSION = "";
      $("authStatus").textContent = msg || "Fa√ßa login para usar.";
      $("btnLogout").style.display = "none";
      $("rolePill").textContent = "‚Äî";
      setTop("N√£o autenticado.");
      $("btnCadastrar").disabled = true;
    }

    function setLoggedInUI_(email, role){
      $("authStatus").textContent = "‚úÖ Logado.";
      $("btnLogout").style.display = "inline-block";
      $("rolePill").textContent = role;
      setTop(`Logado: ${email} (${role})`);
      $("btnCadastrar").disabled = !(role === "admin" || role === "editor");
    }

    function api(action, payload = {}) {
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Date.now() + "_" + Math.random().toString(36).slice(2);
        window[cb] = (data) => {
          try { delete window[cb]; } catch(e) {}
          script.remove();
          resolve(data);
        };

        const params = new URLSearchParams();
        params.set("callback", cb);
        params.set("action", action);
        if (ID_TOKEN) params.set("idToken", ID_TOKEN);
        if (PIN_SESSION) params.set("session", PIN_SESSION);

        Object.keys(payload).forEach(k => {
          const v = payload[k];
          if (v == null) return;
          if (typeof v === "object") params.set(k, encodeURIComponent(JSON.stringify(v)));
          else params.set(k, String(v));
        });

        const script = document.createElement("script");
        script.src = API_URL + "?" + params.toString();
        script.onerror = () => {
          try { delete window[cb]; } catch(e) {}
          script.remove();
          reject(new Error("Falha ao chamar API (JSONP)."));
        };
        document.body.appendChild(script);
      });
    }

    async function validateSession_(){
      const me = await api("me");
      if (!me || !me.ok) throw new Error(me?.message || "Sem permiss√£o.");
      ME = { email: me.email, role: me.role };
      setLoggedInUI_(ME.email, ME.role);
      saveSession_();
      await carregarPagina();
    }

    function initGoogleLogin(){
      const showFallback = (msg) => {
        $("fallbackLogin").style.display = "inline-block";
        diag(msg);
      };

      const start = () => {
        try {
          google.accounts.id.initialize({
            client_id: CLIENT_ID,
            itp_support: true,
            auto_select: false,
            callback: async (resp) => {
              ID_TOKEN = resp.credential || "";
              try { await validateSession_(); }
              catch (e) { showFallback("Falha ao validar acesso: " + (e?.message || e)); }
            }
          });

          google.accounts.id.renderButton($("gsiBtn"), { theme: "outline", size: "large", text: "signin_with" });

          setTimeout(() => {
            const empty = !$("gsiBtn").innerHTML || $("gsiBtn").innerHTML.trim() === "";
            if (empty) showFallback("Bot√£o padr√£o n√£o renderizou. Use o alternativo.");
          }, 1200);

        } catch (e) {
          showFallback("Erro ao iniciar login do Google.");
        }
      };

      const t0 = Date.now();
      (function wait(){
        if (window.__gsiFailed) { showFallback("Falha ao carregar login do Google."); return; }
        if (window.__gsiLoaded && window.google && google.accounts && google.accounts.id) { start(); return; }
        if (Date.now() - t0 > 7000) { showFallback("Login do Google n√£o carregou a tempo."); return; }
        setTimeout(wait, 150);
      })();
    }

    function loginFallback(){
      try { google.accounts.id.prompt(); }
      catch { diag("Falha ao abrir login do Google."); }
    }

    async function loginPin(){
      const email = $("pin_email").value.trim().toLowerCase();
      const pin   = $("pin_code").value.trim();
      if (!email.includes("@")) return diag("Email inv√°lido.");
      if (!pin) return diag("Informe o PIN.");

      const res = await api("pin_login", { email, pin });
      if (!res || !res.ok) return diag(res?.message || "Falha.");

      PIN_SESSION = res.session;
      ID_TOKEN = "";
      await validateSession_();
    }

    function logout(){
      clearSession_();
      try { google.accounts.id.disableAutoSelect(); } catch(e) {}
      setLoggedOutUI_("Voc√™ saiu. Fa√ßa login para usar.");
      showScreen("Cadastrar");
    }

    function showScreen(name){
      $("screenCadastrar").classList.toggle("hidden", name !== "Cadastrar");
      $("screenAcervo").classList.toggle("hidden", name !== "Acervo");
      $("navCadastrar").classList.toggle("active", name === "Cadastrar");
      $("navAcervo").classList.toggle("active", name === "Acervo");
    }

    async function cadastrar(){
      if (!ME) return setStatusCadastrar_("Fa√ßa login.");
      if (!(ME.role === "admin" || ME.role === "editor")) return setStatusCadastrar_("Sem permiss√£o.");

      const isbn = $("isbn").value.trim().replace(/\D/g,"");
      if (!/^\d{13}$/.test(isbn)) return setStatusCadastrar_("ISBN inv√°lido (13 d√≠gitos).");

      setStatusCadastrar_("Processando...", true);
      const extras = { location: $("location").value.trim(), notes: $("notes").value.trim() };

      try{
        let res = await api("cadastrar", { isbn, extras });

        if (res && res.ok && res.exists) {
          const ok = confirm("Item j√° cadastrado. Deseja atualizar o cadastro?");
          if (!ok) { setStatusCadastrar_("Item j√° cadastrado (n√£o atualizado)."); return; }
          res = await api("cadastrar", { isbn, extras, forceUpdate: 1 });
        }

        if (!res || !res.ok) return setStatusCadastrar_(res?.message || "Falhou.");

        setStatusCadastrar_(res.message || "‚úÖ OK.");
        $("isbn").value = "";
        await carregarPagina();
      } catch(e){
        setStatusCadastrar_("Erro: " + (e?.message || e));
      } finally {
        $("btnCadastrar").disabled = !(ME && (ME.role==="admin"||ME.role==="editor"));
      }
    }

    function setStatusCadastrar_(msg, loading=false){
      $("statusCadastrar").textContent = msg || "";
      $("btnCadastrar").disabled = !!loading || !(ME && (ME.role==="admin"||ME.role==="editor"));
    }

    function buscar(){ OFFSET = 0; return carregarPagina(); }

    async function carregarPagina(){
      if (!ME) return;
      const q = $("q") ? $("q").value.trim() : "";
      const res = await api("buscar", { query: q, offset: OFFSET, limit: LIMIT });

      if ($("resumo")) $("resumo").textContent = `Total: ${res.total || 0} | P√°gina: ${Math.floor(OFFSET/LIMIT)+1}`;

      const grid = $("grid");
      if (!grid) return;
      grid.innerHTML = "";

      (res.items||[]).forEach(it=>{
        const tile = document.createElement("div");
        tile.className = "tile";
        tile.addEventListener("click", ()=>openItem(it.id));

        const cover = document.createElement("div");
        cover.className = "cover";

        if (it.cover) {
          const img = document.createElement("img");
          img.src = it.cover;
          img.alt = "capa";
          img.onerror = () => { cover.innerHTML = "Sem capa"; };
          cover.appendChild(img);
        } else {
          cover.textContent = "Sem capa";
        }

        const body = document.createElement("div");
        body.className = "tileBody";
        body.innerHTML = `
          <div class="tileTitle">${esc(it.title||"(sem t√≠tulo)")}</div>
          <div class="tileMeta">${esc(it.authors||"")}</div>
          <div class="tileMeta">${esc(it.publisher||"")} ¬∑ ${esc(it.year||"")}</div>
        `;

        tile.appendChild(cover);
        tile.appendChild(body);
        grid.appendChild(tile);
      });
    }

    function next(){ OFFSET += LIMIT; carregarPagina(); }
    function prev(){ OFFSET = Math.max(0, OFFSET-LIMIT); carregarPagina(); }

    let CURRENT_ITEM = null;

    async function openItem(id){
      if (!ME) return;

      $("m_status").textContent = "Carregando...";
      $("modal").style.display = "block";

      const res = await api("item_get", { id });
      if (!res || !res.ok) {
        $("m_status").textContent = res?.message || "Erro.";
        return;
      }
      CURRENT_ITEM = res.item;
      fillModal_(CURRENT_ITEM);
    }

    function closeModal(){
      $("modal").style.display = "none";
      CURRENT_ITEM = null;
    }

    function fillModal_(it){
      $("m_status").textContent = "";
      $("m_titleTop").textContent = it["T√≠tulo"] || "(sem t√≠tulo)";

      const coverUrl = it["Capa_URL"] || "";
      $("m_coverBox").innerHTML = coverUrl
        ? `<div class="cover" style="height:260px;border-radius:14px;overflow:hidden">
             <img src="${escAttr(coverUrl)}" style="width:100%;height:100%;object-fit:cover"
                  onerror="this.remove(); this.parentNode.textContent='Sem capa';">
           </div>`
        : `<div class="cover" style="height:260px;border-radius:14px">Sem capa</div>`;

      $("m_id").value = it["ID"] || "";
      $("m_isbn").value = it["ISBN"] || "";
      $("m_title").value = it["T√≠tulo"] || "";
      $("m_authors").value = it["Autor(es)"] || "";
      $("m_publisher").value = it["Editora"] || "";
      $("m_edition").value = it["Edi√ß√£o"] || "";
      $("m_year").value = it["Ano"] || "";
      $("m_lang").value = it["Idioma"] || "";
      $("m_pages").value = it["P√°ginas"] || "";
      $("m_source").value = it["Fonte"] || "";
      $("m_link").value = it["Link"] || "";
      $("m_cover").value = it["Capa_URL"] || "";
      $("m_location").value = it["Localiza√ß√£o"] || "";
      $("m_notes").value = it["Observa√ß√µes"] || "";
    }

    async function saveItem(){
      if (!ME || ME.role === "viewer") return;

      const id = $("m_id").value.trim();
      const updates = {
        "T√≠tulo": $("m_title").value,
        "Autor(es)": $("m_authors").value,
        "Editora": $("m_publisher").value,
        "Edi√ß√£o": $("m_edition").value,
        "Ano": $("m_year").value,
        "Idioma": $("m_lang").value,
        "P√°ginas": $("m_pages").value,
        "Link": $("m_link").value,
        "Capa_URL": $("m_cover").value,
        "Localiza√ß√£o": $("m_location").value,
        "Observa√ß√µes": $("m_notes").value
      };

      $("m_status").textContent = "Salvando...";
      const res = await api("item_update", { payload: { id, updates } });

      if (!res || !res.ok) {
        $("m_status").textContent = res?.message || "Erro.";
        return;
      }

      $("m_status").textContent = "‚úÖ Salvo.";
      await carregarPagina();
    }

    // =========================
    // SCANNER multiplataforma (SEM decodeFromVideoElementContinuously)
    // =========================
    let __scanStream = null;
    let __scanTimer = null;
    let __zxingReader = null;

    async function stopStream_(){
      try {
        if (__scanTimer) { clearInterval(__scanTimer); __scanTimer = null; }
        if (__zxingReader) { try { __zxingReader.reset(); } catch(e){} __zxingReader = null; }
        const v = $("video");
        if (v) { try { v.pause(); } catch(e){} v.srcObject = null; }
        if (__scanStream) { __scanStream.getTracks().forEach(t=>t.stop()); __scanStream = null; }
      } catch(e){}
    }

    async function abrirScanner(){
      if (!ME || !(ME.role==="admin" || ME.role==="editor")) return setStatusCadastrar_("Sem permiss√£o.");

      $("scannerModal").style.display = "block";
      $("scanStatus").textContent = "Abrindo c√¢mera‚Ä¶";

      try {
        await stopStream_();

        __scanStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
        const v = $("video");
        v.srcObject = __scanStream;
        await v.play();

        // 1) BarcodeDetector (Chrome/Edge/Android/Windows)
        if ("BarcodeDetector" in window) {
          const detector = new BarcodeDetector({ formats: ["ean_13","ean_8","upc_a","upc_e"] });
          $("scanStatus").textContent = "Aponte para o c√≥digo‚Ä¶";
          __scanTimer = setInterval(async ()=>{
            const codes = await detector.detect(v);
            if (codes && codes.length) {
              const raw = String(codes[0].rawValue || "").replace(/\D/g,"");
              if (raw.length === 13) {
                $("isbn").value = raw;
                $("scanStatus").textContent = "‚úÖ Detectado";
                fecharScanner();
                $("isbn").focus();
              }
            }
          }, 200);
          return;
        }

        // 2) ZXing fallback (Safari/iOS/macOS, etc.)
        if (!window.ZXing || !window.ZXing.BrowserMultiFormatReader) {
          $("scanStatus").textContent = "Scanner ZXing n√£o carregou. Recarregue a p√°gina.";
          return;
        }

        __zxingReader = new window.ZXing.BrowserMultiFormatReader();
        $("scanStatus").textContent = "Aponte para o c√≥digo‚Ä¶";

        // ‚úÖ API est√°vel do @zxing/browser: decodeFromVideoDevice(deviceId, video, callback)
        // deviceId undefined => usa c√¢mera padr√£o sem precisar listVideoInputDevices()
        await __zxingReader.decodeFromVideoDevice(undefined, v, (result, err) => {
          if (result) {
            const raw = String(result.getText() || "").replace(/\D/g,"");
            if (raw.length === 13) {
              $("isbn").value = raw;
              $("scanStatus").textContent = "‚úÖ Detectado";
              fecharScanner();
              $("isbn").focus();
            }
          }
        });

      } catch (e) {
        $("scanStatus").textContent = "Erro c√¢mera: " + (e?.message || e);
      }
    }

    async function fecharScanner(){
      $("scannerModal").style.display = "none";
      await stopStream_();
    }

    // ===== Escape =====
    function esc(s){ return String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])); }
    function escAttr(s){ return esc(s).replace(/"/g,"&quot;"); }

    // ===== Boot =====
    (async function boot(){
      setLoggedOutUI_("Fa√ßa login para usar.");
      initGoogleLogin();

      const saved = loadSession_();
      if (saved) {
        ID_TOKEN = saved.idToken || "";
        PIN_SESSION = saved.session || "";
        if (ID_TOKEN || PIN_SESSION) {
          try { await validateSession_(); }
          catch(e) {
            clearSession_();
            setLoggedOutUI_("Sess√£o expirada. Fa√ßa login novamente.");
            $("fallbackLogin").style.display = "inline-block";
          }
        } else {
          setTop("N√£o autenticado.");
        }
      } else {
        setTop("N√£o autenticado.");
      }

      showScreen("Cadastrar");
    })();
  </script>
</body>
</html>
