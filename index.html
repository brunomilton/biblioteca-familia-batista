<!doctype html>
<html lang="pt-BR">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Google Identity Services (login) -->
  <script>
    window.__gsiLoaded = false;
    window.__gsiFailed = false;
    function __onGsiLoad(){ window.__gsiLoaded = true; }
    function __onGsiError(){ window.__gsiFailed = true; }
  </script>
  <script src="https://accounts.google.com/gsi/client"
          onload="__onGsiLoad()"
          onerror="__onGsiError()"></script>

  <style>
    body { font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial; margin:18px; }
    .card { border:1px solid #ddd; border-radius:14px; padding:14px; margin-bottom:14px; }
    input, textarea { width:100%; padding:10px; border-radius:10px; border:1px solid #ccc; font-size:16px; }
    button { padding:10px 14px; border-radius:12px; border:1px solid #333; background:#111; color:#fff; font-size:16px; }
    button.alt { background:#fff; color:#111; }
    button:disabled { opacity:.6; }
    .small { color:#666; font-size:13px; }
    .list { margin-top:10px; }
    .item { padding:10px 0; border-top:1px solid #eee; }
  </style>
</head>

<body>

<!-- =================== ACESSO =================== -->
<div class="card">
  <b>Acesso</b>
  <div class="small" id="authStatus">Fa√ßa login para usar.</div>

  <div id="gsiBtn" style="margin-top:8px; min-height:44px;"></div>

  <button id="fallbackLogin"
          class="alt"
          style="display:none; margin-top:8px;"
          onclick="loginFallback()">
    Entrar com Google
  </button>

  <div id="diag" class="small" style="margin-top:8px;"></div>
</div>

<!-- =================== T√çTULO =================== -->
<div class="card">
  <h2 style="margin:0 0 8px 0;">üìö Biblioteca - Fam√≠lia Batista</h2>
  <div class="small">Cadastre por ISBN (digitando, leitor ou c√¢mera).</div>
</div>

<!-- =================== CADASTRO =================== -->
<div class="card">
  <label><b>ISBN</b></label>
  <input id="isbn" inputmode="numeric" placeholder="Ex.: 9788576082675" autocomplete="off">

  <div style="height:10px"></div>

  <label><b>Localiza√ß√£o</b> <span class="small">(opcional)</span></label>
  <input id="location" placeholder="Ex.: Estante sala, prateleira 2">

  <div style="height:10px"></div>

  <label><b>Observa√ß√µes</b> <span class="small">(opcional)</span></label>
  <textarea id="notes" rows="2"></textarea>

  <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px;">
    <button id="btn" onclick="cadastrar()">Cadastrar</button>
    <button class="alt" onclick="abrirScanner()">üì∑ Escanear ISBN</button>
    <span id="status" class="small"></span>
  </div>
</div>

<!-- =================== RECENTES =================== -->
<div class="card">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <b>√öltimos cadastrados</b>
    <button class="alt" onclick="carregarRecentes()">Atualizar</button>
  </div>
  <div id="recentes" class="list"></div>
</div>

<!-- =================== ACERVO =================== -->
<div class="card">
  <b>Acervo</b>
  <div class="small">Busque por t√≠tulo, autor, editora, ISBN, ano, localiza√ß√£o...</div>

  <div style="display:flex; gap:10px; margin-top:10px;">
    <input id="q" placeholder="Buscar...">
    <button class="alt" onclick="buscar()">Buscar</button>
  </div>

  <div class="small" id="resumo" style="margin-top:8px;"></div>
  <div id="acervo" class="list"></div>

  <div style="display:flex; gap:10px; margin-top:10px;">
    <button class="alt" onclick="prev()">‚óÄ</button>
    <button class="alt" onclick="next()">‚ñ∂</button>
  </div>
</div>

<!-- =================== SCANNER =================== -->
<div id="scannerModal"
     style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.75); padding:18px;">
  <div style="background:#fff; border-radius:14px; padding:14px; max-width:680px; margin:0 auto;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <b>Escanear ISBN</b>
      <button class="alt" onclick="fecharScanner()">Fechar</button>
    </div>
    <div class="small" style="margin:8px 0;">Aponte para o c√≥digo de barras (EAN-13).</div>
    <video id="video"
           style="width:100%; border-radius:12px; border:1px solid #ddd;"
           autoplay muted playsinline></video>
    <div class="small" id="scanStatus" style="margin-top:8px;"></div>
  </div>
</div>

<!-- ZXing -->
<script type="module">
  import * as ZXing from "https://cdn.jsdelivr.net/npm/@zxing/browser@latest/+esm";
  window.ZXing = ZXing;
</script>

<script>
/* ================= CONFIG ================= */
const CLIENT_ID = "633125662554-rjlr69ihdv7g0njfgl9doacnsmdmkcbh.apps.googleusercontent.com";
const API_URL  = "https://script.google.com/macros/s/AKfycbyMm03BzNNkA5lNbsXBb4CH6cBasRRYO-gtDRkTgUwuULQrjHi1U_YqqBmxwO2AgSAm/exec";

let ID_TOKEN = "";
let OFFSET = 0;
const LIMIT = 50;
let codeReader = null;

const $ = id => document.getElementById(id);

/* ================= LOGIN ================= */
function initLogin() {
  const diag = msg => $("diag").textContent = msg;

  const showFallback = msg => {
    $("fallbackLogin").style.display = "inline-block";
    diag(msg);
  };

  const start = () => {
    try {
      diag("Inicializando login...");

      google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: resp => {
          ID_TOKEN = resp.credential || "";
          $("authStatus").textContent = "‚úÖ Logado.";
          $("fallbackLogin").style.display = "none";
          diag("Token OK.");
          carregarRecentes();
          buscar();
          $("isbn").focus();
        }
      });

      google.accounts.id.renderButton($("gsiBtn"), {
        theme:"outline",
        size:"large",
        text:"signin_with"
      });

      setTimeout(() => {
        if (!$("gsiBtn").innerHTML.trim()) {
          showFallback("Bot√£o padr√£o n√£o renderizou. Use o alternativo.");
        } else {
          diag("Bot√£o de login pronto.");
        }
      }, 900);

    } catch (e) {
      showFallback("Erro ao iniciar login.");
    }
  };

  const t0 = Date.now();
  (function wait(){
    if (window.__gsiFailed) {
      showFallback("Falha ao carregar login do Google.");
      return;
    }
    if (window.__gsiLoaded && window.google && google.accounts) {
      start();
      return;
    }
    if (Date.now() - t0 > 4000) {
      showFallback("Login do Google n√£o carregou a tempo.");
      return;
    }
    setTimeout(wait, 150);
  })();
}

function loginFallback() {
  try {
    google.accounts.id.prompt();
  } catch {
    $("diag").textContent = "Falha ao abrir login.";
  }
}

/* ================= API (JSONP) ================= */
function api(action, payload = {}) {
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Date.now() + "_" + Math.random().toString(36).slice(2);
    window[cb] = data => { delete window[cb]; s.remove(); resolve(data); };

    const p = new URLSearchParams({ callback:cb, action, idToken:ID_TOKEN });
    if (payload.limit) p.set("limit", payload.limit);
    if (payload.offset) p.set("offset", payload.offset);
    if (payload.query) p.set("query", payload.query);
    if (payload.isbn) p.set("isbn", payload.isbn);
    if (payload.extras) p.set("extras", encodeURIComponent(JSON.stringify(payload.extras)));

    const s = document.createElement("script");
    s.src = API_URL + "?" + p.toString();
    s.onerror = () => reject("API error");
    document.body.appendChild(s);
  });
}

/* ================= FUN√á√ïES ================= */
async function cadastrar() {
  if (!ID_TOKEN) return setStatus("Fa√ßa login antes.");
  const isbn = $("isbn").value.trim();
  if (!/^\d{13}$/.test(isbn)) return setStatus("ISBN inv√°lido.");

  setStatus("Buscando...", true);
  try {
    const r = await api("cadastrar", { isbn, extras:{ location:$("location").value, notes:$("notes").value } });
    setStatus(r.ok ? "‚úÖ Cadastrado" : r.message);
    $("isbn").value = "";
    carregarRecentes();
    buscar();
  } catch { setStatus("Erro na API."); }
}

async function carregarRecentes() {
  if (!ID_TOKEN) return;
  const r = await api("recentes",{limit:20});
  $("recentes").innerHTML = (r.items||[]).map(i=>`
    <div class="item">
      <b>${esc(i.title)}</b>
      <div class="small">${esc(i.authors||"")}</div>
    </div>`).join("");
}

function buscar(){ OFFSET=0; carregarPagina(); }
async function carregarPagina(){
  const r = await api("buscar",{query:$("q").value, offset:OFFSET, limit:LIMIT});
  $("resumo").textContent = `Total: ${r.total}`;
  $("acervo").innerHTML = (r.items||[]).map(i=>`
    <div class="item">
      <b>${esc(i.title)}</b>
      <div class="small">${esc(i.authors||"")}</div>
    </div>`).join("");
}
function next(){ OFFSET+=LIMIT; carregarPagina(); }
function prev(){ OFFSET=Math.max(0,OFFSET-LIMIT); carregarPagina(); }

async function abrirScanner(){
  $("scannerModal").style.display="block";
  if (!window.ZXing) return $("scanStatus").textContent="Scanner indispon√≠vel.";
  codeReader = new ZXing.BrowserMultiFormatReader();
  const devs = await ZXing.BrowserCodeReader.listVideoInputDevices();
  const cam = devs.find(d=>/back|rear/i.test(d.label))||devs[0];
  codeReader.decodeFromVideoDevice(cam.deviceId,$("video"),res=>{
    if(res){
      const v=res.getText().replace(/\D/g,"");
      if(v.length===13){
        $("isbn").value=v;
        fecharScanner();
      }
    }
  });
}
function fecharScanner(){ $("scannerModal").style.display="none"; try{codeReader.reset();}catch{} }

function setStatus(m,load=false){ $("status").textContent=m; $("btn").disabled=!!load; }
function esc(s){ return String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])); }

initLogin();
</script>

</body>
</html>
