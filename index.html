<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Biblioteca - Fam√≠lia Batista</title>

  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial;margin:0;background:#f5f6f8}
    .topbar{position:sticky;top:0;background:#fff;padding:14px 16px;border-bottom:1px solid #e6e6e6;z-index:10}
    .title{font-size:18px;font-weight:700}
    .sub{font-size:12px;color:#666;margin-top:2px}
    .wrap{padding:14px 14px 82px}
    .card{background:#fff;border:1px solid #e6e6e6;border-radius:16px;padding:14px;margin-bottom:12px}
    input,textarea,select{width:100%;padding:10px;border-radius:12px;border:1px solid #d7d7d7;font-size:16px;box-sizing:border-box}
    button{padding:10px 14px;border-radius:12px;border:1px solid #333;background:#111;color:#fff;font-size:16px;cursor:pointer}
    button.alt{background:#fff;color:#111;border-color:#bbb}
    button:disabled{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .small{color:#666;font-size:13px}
    .hidden{display:none!important}

    .nav{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #e6e6e6;display:flex}
    .nav button{flex:1;border:none;border-radius:0;background:#fff;color:#111;padding:12px 6px;font-size:13px}
    .nav button.active{font-weight:700}

    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #ddd;font-size:12px;color:#444;background:#fafafa}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-top:12px}
    .tile{background:#fff;border:1px solid #eee;border-radius:14px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.06);cursor:pointer}
    .cover{width:100%;height:190px;background:#eee;display:flex;align-items:center;justify-content:center;font-size:12px;color:#666}
    .cover img{width:100%;height:100%;object-fit:cover;display:block}
    .tileBody{padding:10px}
    .tileTitle{font-weight:700;font-size:13px;line-height:1.2}
    .tileMeta{margin-top:6px;font-size:12px;color:#666;line-height:1.2}

    #modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);padding:14px;z-index:50}
    #modalBox{background:#fff;border-radius:16px;max-width:720px;margin:0 auto;max-height:88vh;overflow:auto;padding:14px}
    #modalHeader{display:flex;justify-content:space-between;align-items:center;gap:10px;position:sticky;top:0;background:#fff;padding-bottom:10px;z-index:5}
    #modalHeader b{font-size:16px}
    .field{margin-top:10px}

    #scannerModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);padding:14px;z-index:60}
    #scannerBox{background:#fff;border-radius:16px;padding:12px;max-width:720px;margin:0 auto}
    #video{width:100%;border-radius:14px;border:1px solid #ddd}

    .rememberRow{display:flex;align-items:center;gap:10px;width:100%}
    .rememberRow input{width:20px;height:20px;flex:0 0 auto}
    .rememberRow span{flex:1 1 auto;white-space:normal;word-break:break-word}

    .hr{height:1px;background:#eee;margin:12px 0}
    .warn{color:#b45309}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="title">üìö Biblioteca - Fam√≠lia Batista</div>
    <div class="sub" id="topStatus">Inicializando‚Ä¶</div>
  </div>

  <div class="wrap">

    <!-- Acesso -->
    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:flex-start;">
        <div>
          <b>Acesso</b>
          <div class="small" id="authStatus">Fa√ßa login para usar.</div>
        </div>
        <div class="row">
          <button id="btnLogout" class="alt" style="display:none" onclick="logout()">Sair</button>
        </div>
      </div>

      <!-- Google -->
      <div style="margin-top:10px">
        <div id="gsiBtn" style="min-height:44px;"></div>

        <!-- ‚úÖ SEMPRE VIS√çVEL (n√£o some mais) -->
        <div class="row" style="margin-top:8px;">
          <button id="btnGoogle" class="alt" onclick="loginWithGoogle()">Entrar com Google</button>
          <span class="small" id="gsiHint"></span>
        </div>
      </div>

      <div class="hr"></div>

      <!-- PIN -->
      <div class="small"><b>Ou entrar com Email + PIN</b></div>
      <div class="row" style="margin-top:8px">
        <input id="pin_email" placeholder="email@exemplo.com" autocomplete="username email">
        <input id="pin_code" placeholder="PIN" type="password" inputmode="numeric" autocomplete="current-password">
        <button class="alt" onclick="loginPin()">Entrar</button>
      </div>

      <div class="small" style="margin-top:10px;">
        <label class="rememberRow">
          <input type="checkbox" id="remember" checked>
          <span>Permanecer logado neste dispositivo</span>
        </label>
      </div>

      <div id="diag" class="small" style="margin-top:8px;"></div>
    </div>

    <!-- ======= TELA: CADASTRAR ======= -->
    <section id="screenCadastrar">
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <b>Cadastrar</b>
          <span class="pill" id="rolePill">‚Äî</span>
        </div>
        <div class="small">Por ISBN (digitando ou scanner) ou manual (sem ISBN).</div>
      </div>

      <div class="card">
        <label><b>ISBN</b></label>
        <input id="isbn" inputmode="numeric" placeholder="Ex.: 9788576082675" autocomplete="off">
        <div style="height:10px"></div>

        <label><b>Localiza√ß√£o</b> <span class="small">(opcional)</span></label>
        <input id="location" placeholder="Ex.: Estante sala, prateleira 2">
        <div style="height:10px"></div>

        <label><b>Observa√ß√µes</b> <span class="small">(opcional)</span></label>
        <textarea id="notes" rows="2"></textarea>

        <div class="row" style="margin-top:10px;">
          <button id="btnCadastrar" onclick="cadastrar()">Cadastrar</button>
          <button class="alt" onclick="abrirScanner()">üì∑ Escanear ISBN</button>
          <button class="alt" onclick="openManual()">‚úçÔ∏è Cadastro manual</button>
        </div>

        <div class="small" id="statusCadastrar" style="margin-top:8px;"></div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <b>√öltimos cadastrados</b>
          <button class="alt" onclick="carregarRecentes()">Atualizar</button>
        </div>
        <div id="recentes" class="small" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- ======= TELA: ACERVO ======= -->
    <section id="screenAcervo" class="hidden">
      <div class="card">
        <b>Acervo</b>
        <div class="small">Busque por t√≠tulo, autor, editora, ID/ISBN, ano, localiza√ß√£o‚Ä¶</div>

        <div class="row" style="margin-top:10px;">
          <input id="q" placeholder="Buscar...">
          <button class="alt" onclick="buscar()">Buscar</button>
        </div>

        <div class="small" id="resumo" style="margin-top:10px;"></div>
        <div id="grid" class="grid"></div>

        <div class="row" style="margin-top:10px;">
          <button class="alt" onclick="prev()">‚óÄ</button>
          <button class="alt" onclick="next()">‚ñ∂</button>
        </div>
      </div>
    </section>

    <!-- ======= TELA: USU√ÅRIOS (ADMIN) ======= -->
    <section id="screenUsers" class="hidden">
      <div class="card">
        <b>Usu√°rios</b>
        <div class="small">Somente admin pode ver/editar.</div>
        <div class="small" id="usersStatus" style="margin-top:8px;"></div>
      </div>

      <div class="card" id="usersAdminCard">
        <b>Adicionar/Atualizar</b>
        <div style="height:10px"></div>

        <label><b>Email</b></label>
        <input id="u_email" placeholder="email@exemplo.com">

        <div style="height:10px"></div>
        <label><b>Role</b></label>
        <select id="u_role">
          <option value="viewer">viewer</option>
          <option value="editor">editor</option>
          <option value="admin">admin</option>
        </select>

        <div style="height:10px"></div>
        <label><b>Ativo</b></label>
        <select id="u_active">
          <option value="true">TRUE</option>
          <option value="false">FALSE</option>
        </select>

        <div style="height:10px"></div>
        <label><b>Nome</b> <span class="small">(opcional)</span></label>
        <input id="u_name" placeholder="Opcional">

        <div style="height:10px"></div>
        <label><b>Definir PIN</b> <span class="small">(opcional)</span></label>
        <input id="u_pin" type="password" inputmode="numeric" placeholder="PIN (min 4) ‚Äî deixe em branco para n√£o alterar">

        <div class="row" style="margin-top:10px;">
          <button id="btnUserSave" onclick="saveUser()">Salvar usu√°rio</button>
          <button class="alt" onclick="loadUsers()">Recarregar</button>
        </div>
      </div>

      <div class="card" id="usersListCard">
        <b>Lista</b>
        <div id="usersList" class="small" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- ======= TELA: STATS ======= -->
    <section id="screenStats" class="hidden">
      <div class="card">
        <b>Estat√≠sticas</b>
        <div class="small" id="statsBox" style="margin-top:10px">‚Äî</div>
      </div>
    </section>

  </div>

  <!-- Bottom Nav -->
  <div class="nav">
    <button id="navCadastrar" class="active" onclick="showScreen('Cadastrar')">Cadastrar</button>
    <button id="navAcervo" onclick="showScreen('Acervo')">Acervo</button>
    <button id="navStats" onclick="showScreen('Stats')">Stats</button>
    <button id="navUsers" onclick="showScreen('Users')">Usu√°rios</button>
  </div>

  <!-- Scanner modal -->
  <div id="scannerModal">
    <div id="scannerBox">
      <div class="row" style="justify-content:space-between;">
        <b>Escanear ISBN</b>
        <button class="alt" onclick="fecharScanner()">Fechar</button>
      </div>
      <div class="small" style="margin:8px 0;">Aponte para o c√≥digo de barras (EAN-13).</div>
      <video id="video" autoplay muted playsinline></video>
      <div class="small" id="scanStatus" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- Modal Item -->
  <div id="modal">
    <div id="modalBox">
      <div id="modalHeader">
        <b id="m_titleTop">Livro</b>
        <button class="alt" onclick="closeModal()">Fechar</button>
      </div>

      <div id="m_coverBox" class="field"></div>

      <div class="field"><label><b>ID</b></label><input id="m_id" disabled></div>
      <div class="field"><label><b>ISBN</b></label><input id="m_isbn" disabled></div>
      <div class="field"><label><b>T√≠tulo</b></label><input id="m_title"></div>
      <div class="field"><label><b>Autor(es)</b></label><input id="m_authors"></div>
      <div class="field"><label><b>Editora</b></label><input id="m_publisher"></div>
      <div class="field"><label><b>Edi√ß√£o</b></label><input id="m_edition"></div>

      <div class="row field">
        <div style="flex:1"><label><b>Ano</b></label><input id="m_year"></div>
        <div style="flex:1"><label><b>Idioma</b></label><input id="m_lang"></div>
      </div>

      <div class="field"><label><b>P√°ginas</b></label><input id="m_pages"></div>
      <div class="field"><label><b>Fonte</b></label><input id="m_source" disabled></div>
      <div class="field"><label><b>Link</b></label><input id="m_link"></div>
      <div class="field"><label><b>Capa_URL (URL)</b></label><input id="m_cover"></div>
      <div class="field"><label><b>Localiza√ß√£o</b></label><input id="m_location"></div>
      <div class="field"><label><b>Observa√ß√µes</b></label><textarea id="m_notes" rows="4"></textarea></div>

      <div class="row field">
        <button id="btnSaveItem" onclick="saveItem()">Salvar altera√ß√µes</button>
        <span class="small" id="m_status"></span>
      </div>
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    const CLIENT_ID = "633125662554-rjlr69ihdv7g0njfgl9doacnsmdmkcbh.apps.googleusercontent.com";
    const API_URL  = "https://script.google.com/macros/s/AKfycbyMm03BzNNkA5lNbsXBb4CH6cBasRRYO-gtDRkTgUwuULQrjHi1U_YqqBmxwO2AgSAm/exec";
    const STORAGE_KEY = "bib_session_v3";

    // ========= STATE =========
    let ID_TOKEN = "";
    let PIN_SESSION = "";
    let ME = null;
    let OFFSET = 0;
    const LIMIT = 30;

    let codeReader = null; // ZXing
    let zxingLoaded = false;

    // ========= HELPERS =========
    const $ = id => document.getElementById(id);
    function setTop(msg){ $("topStatus").textContent = msg || ""; }
    function diag(msg, warn=false){
      $("diag").innerHTML = warn ? `<span class="warn">${esc(msg)}</span>` : esc(msg||"");
    }

    window.addEventListener("error", (ev)=>{
      diag("Erro JS: " + (ev?.message || ev), true);
      setTop("Erro na p√°gina (veja diagn√≥stico).");
    });
    window.addEventListener("unhandledrejection", (ev)=>{
      diag("Promise rejeitada: " + (ev?.reason?.message || ev?.reason || ev), true);
      setTop("Erro na p√°gina (veja diagn√≥stico).");
    });

    function saveSession_(){
      if (!$("remember").checked) return;
      const obj = { idToken: ID_TOKEN, session: PIN_SESSION };
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); } catch(e){}
    }
    function loadSession_(){
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "null"); } catch(e){ return null; }
    }
    function clearSession_(){
      try { localStorage.removeItem(STORAGE_KEY); } catch(e){}
    }

    function setLoggedOutUI_(msg){
      ME = null;
      ID_TOKEN = "";
      PIN_SESSION = "";
      $("authStatus").textContent = msg || "Fa√ßa login para usar.";
      $("btnLogout").style.display = "none";
      $("rolePill").textContent = "‚Äî";
      setTop("N√£o autenticado.");
      $("navUsers").classList.add("hidden");
      $("screenUsers").classList.add("hidden");
      $("btnCadastrar").disabled = true;
    }

    function setLoggedInUI_(email, role){
      $("authStatus").textContent = "‚úÖ Logado.";
      $("btnLogout").style.display = "inline-block";
      $("rolePill").textContent = role;
      setTop(`Logado: ${email} (${role})`);
      $("btnCadastrar").disabled = !(role === "admin" || role === "editor");
      if (role === "admin") $("navUsers").classList.remove("hidden");
      else {
        $("navUsers").classList.add("hidden");
        $("screenUsers").classList.add("hidden");
      }
    }

    // ========= JSONP (robusto + anti-cache) =========
    function api(action, payload = {}) {
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Date.now() + "_" + Math.random().toString(36).slice(2);
        const params = new URLSearchParams();
        params.set("callback", cb);
        params.set("action", action);
        params.set("t", Date.now().toString()); // evita cache
        if (ID_TOKEN) params.set("idToken", ID_TOKEN);
        if (PIN_SESSION) params.set("session", PIN_SESSION);

        Object.keys(payload).forEach(k => {
          const v = payload[k];
          if (v == null) return;
          params.set(k, (typeof v === "object") ? JSON.stringify(v) : String(v));
        });

        const script = document.createElement("script");
        window[cb] = (data) => {
          try { delete window[cb]; } catch(e) {}
          script.remove();
          resolve(data);
        };

        script.src = API_URL + "?" + params.toString();
        script.onerror = () => {
          try { delete window[cb]; } catch(e) {}
          script.remove();
          reject(new Error("Falha ao chamar API (JSONP)."));
        };
        document.body.appendChild(script);
      });
    }

    async function validateSession_(){
      const me = await api("me");
      if (!me || !me.ok) throw new Error(me?.message || "Sem permiss√£o.");
      ME = { email: me.email, role: me.role };
      setLoggedInUI_(ME.email, ME.role);
      saveSession_();
      await carregarRecentes();
      await buscar();
      if (ME.role === "admin") loadUsers();
      loadStats();
    }

    // ========= GOOGLE LOGIN (N√ÉO SOME) =========
    function loadGsiScript_(){
      return new Promise((resolve, reject)=>{
        if (window.google && google.accounts && google.accounts.id) return resolve(true);

        // j√° existe tag?
        const existing = document.querySelector('script[data-gsi="1"]');
        if (existing) {
          // espera um pouco
          const t0 = Date.now();
          (function wait(){
            if (window.google && google.accounts && google.accounts.id) return resolve(true);
            if (Date.now()-t0 > 7000) return reject(new Error("GSI n√£o carregou a tempo."));
            setTimeout(wait, 150);
          })();
          return;
        }

        const s = document.createElement("script");
        s.src = "https://accounts.google.com/gsi/client";
        s.async = true;
        s.defer = true;
        s.dataset.gsi = "1";
        s.onload = ()=>resolve(true);
        s.onerror = ()=>reject(new Error("Falha ao carregar script do Google."));
        document.head.appendChild(s);
      });
    }

    function initGoogleButton_(){
      if (!(window.google && google.accounts && google.accounts.id)) {
        $("gsiHint").textContent = "Google n√£o carregou (use o bot√£o acima para tentar novamente).";
        return;
      }

      try{
        google.accounts.id.initialize({
          client_id: CLIENT_ID,
          itp_support: true,
          auto_select: false,
          callback: async (resp) => {
            ID_TOKEN = resp.credential || "";
            diag("Token Google recebido.");
            try {
              await validateSession_();
            } catch (e) {
              diag("Falha ao validar acesso: " + (e?.message || e), true);
            }
          }
        });

        // Render do bot√£o ‚Äúbonito‚Äù (se funcionar)
        try{
          $("gsiBtn").innerHTML = "";
          google.accounts.id.renderButton($("gsiBtn"), { theme:"outline", size:"large", text:"signin_with" });
        } catch(e){}

        $("gsiHint").textContent = "";
      } catch(e){
        diag("Erro ao iniciar Google: " + (e?.message || e), true);
      }
    }

    async function loginWithGoogle(){
      diag("Abrindo login do Google‚Ä¶");
      try{
        await loadGsiScript_();
        initGoogleButton_();
        // prompt abre fluxo mesmo se o render falhar
        google.accounts.id.prompt();
      } catch(e){
        diag("Login Google indispon√≠vel: " + (e?.message || e), true);
      }
    }

    // ========= PIN LOGIN =========
    async function loginPin(){
      const email = $("pin_email").value.trim().toLowerCase();
      const pin   = $("pin_code").value.trim();
      if (!email.includes("@")) return diag("Email inv√°lido.", true);
      if (!pin) return diag("Informe o PIN.", true);

      diag("Autenticando PIN‚Ä¶");
      const res = await api("pin_login", { email, pin });
      if (!res || !res.ok) return diag(res?.message || "Falha.", true);

      PIN_SESSION = res.session;
      ID_TOKEN = "";
      diag("PIN OK.");
      await validateSession_();
    }

    function logout(){
      clearSession_();
      try { if (window.google && google.accounts && google.accounts.id) google.accounts.id.disableAutoSelect(); } catch(e){}
      setLoggedOutUI_("Voc√™ saiu. Fa√ßa login para usar.");
      diag("Sess√£o removida deste dispositivo.");
      showScreen("Cadastrar");
    }

    // ========= NAV =========
    function showScreen(name){
      $("screenCadastrar").classList.toggle("hidden", name !== "Cadastrar");
      $("screenAcervo").classList.toggle("hidden", name !== "Acervo");
      $("screenUsers").classList.toggle("hidden", name !== "Users");
      $("screenStats").classList.toggle("hidden", name !== "Stats");

      $("navCadastrar").classList.toggle("active", name === "Cadastrar");
      $("navAcervo").classList.toggle("active", name === "Acervo");
      $("navUsers").classList.toggle("active", name === "Users");
      $("navStats").classList.toggle("active", name === "Stats");

      if (name === "Users" && ME && ME.role === "admin") loadUsers();
    }

    // ========= CADASTRO =========
    async function cadastrar(){
      if (!ME) return setStatusCadastrar_("Fa√ßa login.");
      if (!(ME.role === "admin" || ME.role === "editor")) return setStatusCadastrar_("Sem permiss√£o.");

      const isbn = $("isbn").value.trim().replace(/\D/g,"");
      if (!/^\d{13}$/.test(isbn)) return setStatusCadastrar_("ISBN inv√°lido (13 d√≠gitos).");

      setStatusCadastrar_("Processando...", true);
      const extras = { location: $("location").value.trim(), notes: $("notes").value.trim() };

      try{
        let res = await api("cadastrar", { isbn, extras });

        if (res && res.ok && res.exists) {
          const ok = confirm("Item j√° cadastrado. Deseja atualizar o cadastro?");
          if (!ok) { setStatusCadastrar_("Item j√° cadastrado (n√£o atualizado)."); return; }
          res = await api("cadastrar", { isbn, extras, forceUpdate: 1 });
        }

        if (!res || !res.ok) return setStatusCadastrar_(res?.message || "Falhou.");

        setStatusCadastrar_(res.message || "‚úÖ OK.");
        $("isbn").value = "";
        await carregarRecentes();
        await buscar();
      } catch(e){
        setStatusCadastrar_("Erro: " + (e?.message || e));
      } finally {
        $("btnCadastrar").disabled = !(ME && (ME.role==="admin"||ME.role==="editor"));
      }
    }

    function setStatusCadastrar_(msg, loading=false){
      $("statusCadastrar").textContent = msg || "";
      $("btnCadastrar").disabled = !!loading || !(ME && (ME.role==="admin"||ME.role==="editor"));
    }

    async function carregarRecentes(){
      if (!ME) return;
      const res = await api("recentes", { limit: 10 });
      const box = $("recentes");
      box.innerHTML = "";
      (res.items || []).forEach(it=>{
        const line = document.createElement("div");
        line.style.padding = "8px 0";
        line.style.borderTop = "1px solid #eee";
        line.innerHTML = `<b>${esc(it.title||"(sem t√≠tulo)")}</b><br><span class="small">${esc(it.authors||"")}</span>`;
        box.appendChild(line);
      });
    }

    // ========= ACERVO =========
    function buscar(){ OFFSET = 0; return carregarPagina(); }

    async function carregarPagina(){
      if (!ME) return;
      const q = $("q").value.trim();
      const res = await api("buscar", { query: q, offset: OFFSET, limit: LIMIT });

      $("resumo").textContent = `Total: ${res.total || 0} | P√°gina: ${Math.floor(OFFSET/LIMIT)+1}`;
      const grid = $("grid");
      grid.innerHTML = "";

      (res.items||[]).forEach(it=>{
        const tile = document.createElement("div");
        tile.className = "tile";
        tile.addEventListener("click", ()=>openItem(it.id));

        const cover = document.createElement("div");
        cover.className = "cover";
        if (it.cover) {
          cover.innerHTML = `<img src="${escAttr(it.cover)}" alt="capa" onerror="this.remove(); this.parentNode.textContent='Sem capa';">`;
        } else {
          cover.textContent = "Sem capa";
        }

        const body = document.createElement("div");
        body.className = "tileBody";
        body.innerHTML = `
          <div class="tileTitle">${esc(it.title||"(sem t√≠tulo)")}</div>
          <div class="tileMeta">${esc(it.authors||"")}</div>
          <div class="tileMeta">${esc(it.publisher||"")} ¬∑ ${esc(it.year||"")}</div>
        `;

        tile.appendChild(cover);
        tile.appendChild(body);
        grid.appendChild(tile);
      });
    }

    function next(){ OFFSET += LIMIT; carregarPagina(); }
    function prev(){ OFFSET = Math.max(0, OFFSET-LIMIT); carregarPagina(); }

    // ========= MODAL =========
    let CURRENT_ITEM = null;

    async function openItem(id){
      if (!ME) return;
      $("m_status").textContent = "Carregando...";
      $("modal").style.display = "block";

      const res = await api("item_get", { id });
      if (!res || !res.ok) {
        $("m_status").textContent = res?.message || "Erro.";
        return;
      }
      CURRENT_ITEM = res.item;
      fillModal_(CURRENT_ITEM);
    }

    function closeModal(){
      $("modal").style.display = "none";
      CURRENT_ITEM = null;
    }

    function fillModal_(it){
      $("m_status").textContent = "";
      $("m_titleTop").textContent = it["T√≠tulo"] || "(sem t√≠tulo)";

      const coverUrl = it["Capa_URL"] || "";
      $("m_coverBox").innerHTML = coverUrl
        ? `<div class="cover" style="height:260px;border-radius:14px;overflow:hidden"><img src="${escAttr(coverUrl)}" style="width:100%;height:100%;object-fit:cover" onerror="this.remove(); this.parentNode.textContent='Sem capa';"></div>`
        : `<div class="cover" style="height:260px;border-radius:14px">Sem capa</div>`;

      $("m_id").value = it["ID"] || "";
      $("m_isbn").value = it["ISBN"] || "";
      $("m_title").value = it["T√≠tulo"] || "";
      $("m_authors").value = it["Autor(es)"] || "";
      $("m_publisher").value = it["Editora"] || "";
      $("m_edition").value = it["Edi√ß√£o"] || "";
      $("m_year").value = it["Ano"] || "";
      $("m_lang").value = it["Idioma"] || "";
      $("m_pages").value = it["P√°ginas"] || "";
      $("m_source").value = it["Fonte"] || "";
      $("m_link").value = it["Link"] || "";
      $("m_cover").value = it["Capa_URL"] || "";
      $("m_location").value = it["Localiza√ß√£o"] || "";
      $("m_notes").value = it["Observa√ß√µes"] || "";

      const role = ME?.role || "viewer";
      const setRO = (id, ro)=>{ $(id).disabled = ro; };

      if (role === "viewer") {
        ["m_title","m_authors","m_publisher","m_edition","m_year","m_lang","m_pages","m_link","m_cover","m_location","m_notes"].forEach(x=>setRO(x,true));
        $("btnSaveItem").disabled = true;
        $("btnSaveItem").textContent = "Sem permiss√£o";
      } else if (role === "editor") {
        ["m_title","m_authors","m_publisher","m_edition","m_year","m_lang","m_pages","m_link"].forEach(x=>setRO(x,true));
        ["m_cover","m_location","m_notes"].forEach(x=>setRO(x,false));
        $("btnSaveItem").disabled = false;
        $("btnSaveItem").textContent = "Salvar altera√ß√µes";
      } else {
        ["m_title","m_authors","m_publisher","m_edition","m_year","m_lang","m_pages","m_link","m_cover","m_location","m_notes"].forEach(x=>setRO(x,false));
        $("btnSaveItem").disabled = false;
        $("btnSaveItem").textContent = "Salvar altera√ß√µes";
      }
    }

    async function saveItem(){
      if (!ME || ME.role === "viewer") return;

      const id = $("m_id").value.trim();
      const updates = {
        "T√≠tulo": $("m_title").value,
        "Autor(es)": $("m_authors").value,
        "Editora": $("m_publisher").value,
        "Edi√ß√£o": $("m_edition").value,
        "Ano": $("m_year").value,
        "Idioma": $("m_lang").value,
        "P√°ginas": $("m_pages").value,
        "Link": $("m_link").value,
        "Capa_URL": $("m_cover").value,
        "Localiza√ß√£o": $("m_location").value,
        "Observa√ß√µes": $("m_notes").value
      };

      $("m_status").textContent = "Salvando...";
      const res = await api("item_update", { payload: { id, updates } });

      if (!res || !res.ok) {
        $("m_status").textContent = res?.message || "Erro.";
        return;
      }

      $("m_status").textContent = "‚úÖ Salvo.";
      await carregarPagina();
    }

    function openManual(){
      alert("Se voc√™ quiser, eu reativo a tela manual completa. Mantive simples aqui para estabilizar login/fluxo.");
    }

    // ========= SCANNER (ZXING sob demanda) =========
    async function loadZxing_(){
      if (zxingLoaded) return true;
      return new Promise((resolve, reject)=>{
        const s = document.createElement("script");
        s.src = "https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js";
        s.onload = ()=>{ zxingLoaded = true; resolve(true); };
        s.onerror = ()=>reject(new Error("Falha ao carregar ZXing."));
        document.head.appendChild(s);
      });
    }

    async function abrirScanner(){
      if (!ME || !(ME.role==="admin" || ME.role==="editor")) return setStatusCadastrar_("Sem permiss√£o.");
      $("scannerModal").style.display = "block";
      $("scanStatus").textContent = "Abrindo c√¢mera‚Ä¶";

      try{
        await loadZxing_();
      } catch(e){
        $("scanStatus").textContent = "Scanner indispon√≠vel: " + (e?.message || e);
        return;
      }

      try {
        // UMD: ZXing j√° existe em window.ZXing
        const ZX = window.ZXing;
        if (!ZX) throw new Error("ZXing n√£o dispon√≠vel.");

        codeReader = new ZX.BrowserMultiFormatReader();

        const devices = await ZX.BrowserCodeReader.listVideoInputDevices();
        const backCam = devices.find(d => /back|traseira|rear/i.test(d.label)) || devices[0];

        await codeReader.decodeFromVideoDevice(backCam?.deviceId, $("video"), (result) => {
          if (result) {
            const raw = String(result.text || result.getText?.() || "").replace(/\D/g, "");
            if (raw.length !== 13) return;
            $("isbn").value = raw;
            $("scanStatus").textContent = "‚úÖ Detectado";
            fecharScanner();
            $("isbn").focus();
          }
        });

        $("scanStatus").textContent = "Aponte para o c√≥digo‚Ä¶";
      } catch (e) {
        $("scanStatus").textContent = "Erro c√¢mera: " + (e?.message || e);
      }
    }

    function fecharScanner(){
      $("scannerModal").style.display = "none";
      try { codeReader && codeReader.reset(); } catch(e){}
      codeReader = null;
    }

    // ========= USERS / STATS =========
    async function loadUsers(){
      if (!ME || ME.role !== "admin") return;
      $("usersStatus").textContent = "Carregando‚Ä¶";
      const res = await api("users_list");
      if (!res || !res.ok) { $("usersStatus").textContent = res?.message || "Erro."; return; }

      $("usersStatus").textContent = "OK.";
      const list = $("usersList");
      list.innerHTML = "";

      (res.users||[]).forEach(u=>{
        const box = document.createElement("div");
        box.style.padding = "10px 0";
        box.style.borderTop = "1px solid #eee";
        box.innerHTML = `<b>${esc(u.email)}</b><div class="small" style="margin-top:6px">role: ${esc(u.role)} ¬∑ active: ${u.active ? "TRUE":"FALSE"} ¬∑ ${esc(u.name||"")}</div>`;
        const row = document.createElement("div");
        row.className = "row";
        row.style.marginTop = "8px";
        const btn = document.createElement("button");
        btn.className = "alt";
        btn.textContent = "Editar";
        btn.addEventListener("click", ()=>{
          $("u_email").value = u.email || "";
          $("u_role").value = u.role || "viewer";
          $("u_active").value = u.active ? "true" : "false";
          $("u_name").value = u.name || "";
          $("u_pin").value = "";
          $("usersStatus").textContent = "Carregado para edi√ß√£o.";
        });
        row.appendChild(btn);
        box.appendChild(row);
        list.appendChild(box);
      });
    }

    async function saveUser(){
      if (!ME || ME.role !== "admin") return;

      const user = {
        email: $("u_email").value.trim().toLowerCase(),
        role: $("u_role").value,
        active: $("u_active").value === "true",
        name: $("u_name").value.trim()
      };
      if (!user.email.includes("@")) { $("usersStatus").textContent = "Email inv√°lido."; return; }

      $("usersStatus").textContent = "Salvando‚Ä¶";
      const res = await api("users_upsert", { user });
      if (!res || !res.ok) { $("usersStatus").textContent = res?.message || "Erro."; return; }

      const pin = $("u_pin").value.trim();
      if (pin) {
        const r2 = await api("users_set_pin", { payload: { email: user.email, pin } });
        if (!r2 || !r2.ok) { $("usersStatus").textContent = "Usu√°rio salvo, mas falha ao definir PIN."; return; }
      }

      $("usersStatus").textContent = `‚úÖ ${res.action}`;
      await loadUsers();
    }

    async function loadStats(){
      if (!ME) return;
      const res = await api("stats");
      if (!res || !res.ok) return;
      const lines = [];
      lines.push(`<b>Total de t√≠tulos:</b> ${res.total}`);
      lines.push(`<br><br><b>Top autores:</b><br>` + ((res.topAuthors||[]).map(a=>`${esc(a.name)} (${a.count})`).join("<br>") || "‚Äî"));
      lines.push(`<br><br><b>Top editoras:</b><br>` + ((res.topPublishers||[]).map(a=>`${esc(a.name)} (${a.count})`).join("<br>") || "‚Äî"));
      $("statsBox").innerHTML = lines.join("");
    }

    // ========= ESCAPE =========
    function esc(s){ return String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])); }
    function escAttr(s){ return esc(s).replace(/"/g,"&quot;"); }

    // ========= BOOT =========
    (async function boot(){
      setLoggedOutUI_("Fa√ßa login para usar.");
      setTop("N√£o autenticado.");

      // tenta carregar GSI no boot (mas N√ÉO quebra se falhar)
      try{
        await loadGsiScript_();
        initGoogleButton_();
      } catch(e){
        $("gsiHint").textContent = "Google n√£o carregou automaticamente. Use o bot√£o para tentar.";
      }

      const saved = loadSession_();
      if (saved) {
        ID_TOKEN = saved.idToken || "";
        PIN_SESSION = saved.session || "";
        if (ID_TOKEN || PIN_SESSION) {
          diag("Sess√£o salva encontrada. Validando‚Ä¶");
          try {
            await validateSession_();
            diag("Sess√£o ativa.");
          } catch(e) {
            clearSession_();
            setLoggedOutUI_("Sess√£o expirada. Fa√ßa login novamente.");
            diag("Sess√£o expirada.", true);
          }
        }
      }

      showScreen("Cadastrar");
    })();
  </script>
</body>
</html>
